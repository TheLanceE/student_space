<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>EduMind+ | Quizzes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f7fb; margin: 0; padding: 0; }
    .navbar { background-color: #4361ee; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar-brand { color: white; font-weight: bold; font-size: 24px; text-decoration: none; margin-left: 20px; }
    .nav-links { display: block; list-style: none; margin: 0; padding: 0; margin-left: 30px; float: left; }
    .nav-links li { float: left; margin-right: 20px; }
    .nav-links a { color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; display: block; }
    .nav-links a.active { background-color: rgba(255,255,255,0.2); }
    .user-role { background: rgba(255,255,255,0.2); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-left: 10px; cursor: pointer; float: left; }
    .container { width: 1200px; margin: 0 auto; padding: 20px; }
    .welcome-section { background: #4361ee; color: white; border-radius: 10px; padding: 30px; margin-bottom: 30px; }
    .card { background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; padding: 20px; border: 1px solid #e0e0e0; }
    .stats-card { text-align: center; padding: 20px 15px; }
    .stats-card i { font-size: 32px; margin-bottom: 15px; color: #4361ee; }
    .stats-card .number { font-size: 32px; font-weight: bold; margin: 10px 0; }
    .quiz-card { position: relative; height: auto; margin-bottom: 20px; }
    .quiz-badge { position: absolute; top: 15px; right: 15px; background: #4361ee; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 12px; }
    .btn-primary { background: #4361ee; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-success { background: #4cc9f0; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-outline-primary { background: transparent; color: #4361ee; border: 1px solid #4361ee; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
    .btn-danger { background: #e63946; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
    .form-select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
    .hidden { display: none; }
    .nav-tabs { border-bottom: 2px solid #e0e0e0; display: block; list-style: none; padding: 0; margin: 0; }
    .nav-tabs li { float: left; margin-right: 10px; }
    .nav-tabs a { padding: 12px 25px; text-decoration: none; color: #666; font-weight: bold; border-bottom: 3px solid transparent; display: block; }
    .nav-tabs a.active { color: #4361ee; border-bottom: 3px solid #4361ee; }
    .tab-content { padding: 20px 0; clear: both; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .questions-section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0; }
    .question-item { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #e0e0e0; }
    .question-header { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0; overflow: hidden; }
    .option-group { margin-top: 15px; }
    .option-row { margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #e0e0e0; overflow: hidden; }
    .option-label { width: 30px; font-weight: bold; color: #4361ee; float: left; margin-right: 10px; }
    .option-input { width: 65%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; float: left; }
    .correct-option { width: 30%; text-align: center; float: right; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .correct-answer-display { padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #4cc9f0; margin-top: 10px; }
    .form-text { font-size: 12px; margin-top: 4px; color: #e63946; display: block; }
    .error-message { color: #e63946; font-size: 12px; margin-top: 5px; }
    .success-message { color: #2ecc71; font-size: 14px; margin-top: 10px; }
    .teacher-badge { background: #4cc9f0; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px; }
    .clearfix:after { content: ""; display: table; clear: both; }
    .clearfix { zoom: 1; }
    .row { overflow: hidden; margin: 0 -10px; }
    .col-md-3, .col-md-4, .col-md-6, .col-md-8 { float: left; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; padding: 0 10px; }
    .col-md-3 { width: 25%; }
    .col-md-4 { width: 33.333%; }
    .col-md-6 { width: 50%; }
    .col-md-8 { width: 66.666%; }
    .text-end { text-align: right; }
    .section-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
    .section-subheader { font-size: 16px; font-weight: bold; margin: 15px 0 10px 0; color: #555; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    .quiz-list { overflow: hidden; }
    .empty-state { text-align: center; padding: 40px; color: #666; }
    .empty-state i { font-size: 48px; margin-bottom: 15px; color: #ddd; }
    .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .preview-content { position: absolute; top: 50%; left: 50%; margin-left: -400px; margin-top: -45vh; background: white; border-radius: 10px; width: 800px; max-height: 90vh; overflow-y: auto; }
    .preview-header { padding: 20px; border-bottom: 1px solid #e0e0e0; overflow: hidden; }
    .preview-body { padding: 20px; }
    .preview-question { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .preview-options { margin-top: 10px; }
    .preview-option { padding: 10px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #e0e0e0; }
    .preview-option.correct { background: #e8f5e8; border-color: #2ecc71; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; float: right; }
    .badge { display: inline-block; padding: 3px 8px; font-size: 12px; font-weight: bold; border-radius: 4px; }
    .bg-success { background: #2ecc71; color: white; }
    .bg-secondary { background: #95a5a6; color: white; }
    .bg-primary { background: #4361ee; color: white; }
  </style>
</head>
<body>
  <!-- NAVIGATION BAR -->
  <div class="navbar">
    <div class="container">
      <div class="clearfix">
        <a href="#" class="navbar-brand">
          <i class="fas fa-graduation-cap"></i> EduMind
        </a>
        <ul class="nav-links">
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="#" class="active">Quizzes</a></li>
          <li><a href="profile.html">Profile</a></li>
        </ul>
        <div style="float: right;">
          <span class="user-role" id="userRole">Teacher</span>
          <button class="btn-outline-primary" style="color: white; border-color: white; margin-left: 10px;">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="container">
    <!-- WELCOME SECTION -->
    <div class="welcome-section">
      <div class="row">
        <div class="col-md-8">
          <h1 style="margin: 0 0 10px 0;">Welcome to EduMind Quizzes</h1>
          <p style="margin: 0; font-size: 16px;">Create and manage quizzes for your students.</p>
        </div>
        <div class="col-md-4 text-end">
          <div style="background: white; color: #4361ee; border-radius: 50%; width: 80px; height: 80px; display: inline-block; text-align: center; line-height: 80px;">
            <i class="fas fa-brain" style="font-size: 32px;"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- STATS CARDS -->
    <div class="row" style="margin-bottom: 20px;">
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-list-alt"></i>
          <div class="number" id="availableQuizzes">0</div>
          <div>Available Quizzes</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-check-circle"></i>
          <div class="number" id="completedQuizzes">0</div>
          <div>Quizzes Completed</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-trophy"></i>
          <div class="number" id="averageScore">0%</div>
          <div>Average Score</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-plus-circle"></i>
          <div class="number" id="myQuizzesCount">0</div>
          <div>My Created Quizzes</div>
        </div>
      </div>
    </div>

    <!-- TABS SECTION -->
    <ul class="nav-tabs" id="mainTabs">
      <li class="teacher-only"><a href="#browse-quizzes" class="active">Browse Quizzes</a></li>
      <li class="teacher-only"><a href="#create-quiz">Create Quiz</a></li>
      <li class="teacher-only"><a href="#my-quizzes">My Quizzes</a></li>
    </ul>
    
    <div class="tab-content">
      <!-- TAB 1: BROWSE QUIZZES -->
      <div id="browse-quizzes" class="tab-pane active teacher-only">
        <h2 style="margin-bottom: 20px;">Available Quizzes</h2>
        <div class="quiz-list" id="browseQuizzesContainer">
          <!-- Quizzes will be dynamically added here -->
        </div>
      </div>
      
      <!-- TAB 2: CREATE QUIZ -->
      <div id="create-quiz" class="tab-pane teacher-only">
        <div class="card">
          <div class="card-header">
            <h3 style="margin: 0;">Create New Quiz</h3>
          </div>
          <div class="card-body">
            <!-- FIXED FORM ACTION -->
            <!-- In the Create Quiz tab -->
              <form id="quizForm" method="POST" action="../controller/quizcontroller.php?action=create">
                <input type="hidden" id="quizId" name="quiz_id" value="">
              <!-- QUIZ BASIC INFORMATION -->
              <div class="section-header">Quiz Information</div>
              
              <!-- Quiz Title -->
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Quiz Title *</label>
                    <input type="text" class="form-control" id="quizTitle" name="title" placeholder="Enter quiz title">
                    <small id="quizTitle_error" class="form-text"></small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select class="form-select" id="quizCategory" name="category">
                      <option value="">Select category</option>
                      <optgroup label="Core Subjects">
                        <option value="math">Mathematics</option>
                        <option value="science">Science</option>
                        <option value="english">English Language Arts</option>
                        <option value="social-studies">Social Studies</option>
                        <option value="history">History</option>
                        <option value="geography">Geography</option>
                      </optgroup>
                      <optgroup label="Science Specializations">
                        <option value="biology">Biology</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="physics">Physics</option>
                        <option value="earth-science">Earth Science</option>
                        <option value="environmental-science">Environmental Science</option>
                        <option value="astronomy">Astronomy</option>
                      </optgroup>
                      <optgroup label="Other">
                        <option value="art">Art</option>
                        <option value="music">Music</option>
                        <option value="other">Other</option>
                      </optgroup>
                    </select>
                    <small id="quizCategory_error" class="form-text"></small>
                  </div>
                </div>
              </div>
              
              <!-- Grade Level and Time Limit -->
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Grade Level *</label>
                    <select class="form-select" id="quizGrade" name="gradeLevel">
                      <option value="">Select grade</option>
                      <optgroup label="Elementary School">
                        <option value="1">Grade 1</option>
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                      </optgroup>
                      <optgroup label="Middle School">
                        <option value="6">Grade 6</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                      </optgroup>
                      <optgroup label="High School">
                        <option value="9">Grade 9 (Freshman)</option>
                        <option value="10">Grade 10 (Sophomore)</option>
                        <option value="11">Grade 11 (Junior)</option>
                        <option value="12">Grade 12 (Senior)</option>
                      </optgroup>
                    </select>
                    <small id="quizGrade_error" class="form-text"></small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Time Limit (minutes)</label>
                    <input type="text" class="form-control" id="timeLimit" name="time_limit" placeholder="e.g., 30">
                  </div>
                </div>
              </div>
              <!-- Passing Grade and Status -->
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Passing Grade (%) *</label>
                    <input type="text" class="form-control" id="passingGrade" name="passing_grade" placeholder="e.g., 70">
                    <small id="passingGrade_error" class="form-text"></small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Quiz Status *</label>
                    <div style="margin-top: 8px;">
                      <input type="radio" name="status" id="statusActive" value="active" checked="checked">
                      <label for="statusActive">Active</label>
                      <input type="radio" name="status" id="statusDraft" value="draft" style="margin-left: 15px;">
                      <label for="statusDraft">Draft</label>
                      <input type="radio" name="status" id="statusInactive" value="inactive" style="margin-left: 15px;">
                      <label for="statusInactive">Inactive</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Description -->
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="quizDescription" name="description" rows="3" placeholder="Enter quiz description (optional)"></textarea>
              </div>
              <!-- QUESTIONS SECTION -->
              <div class="questions-section">
                <div class="section-header">Quiz Questions</div>
                <p>Add questions with multiple choice options. Don't forget to set the correct answer for each question.</p>
                <small id="questions_error" class="form-text"></small>
                
                <div id="questionsContainer">
                  <!-- Questions will be added here by JavaScript -->
                </div>
                
                <button type="button" class="btn-outline-primary" id="addQuestionBtn">
                  <i class="fas fa-plus"></i> Add New Question
                </button>
              </div>
              
              <!-- FORM BUTTONS -->
              <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <button type="button" class="btn-success" id="submitQuizBtn">
                  <i class="fas fa-save"></i> Save & Publish Quiz
                </button>
                <button type="button" class="btn-outline-primary" style="color: #666; border-color: #666;" id="cancelQuizBtn">
                  Cancel
                </button>
                <div style="margin-top:10px;">
                  <small id="form_message" class="form-text"></small>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- TAB 3: MY QUIZZES -->
      <div id="my-quizzes" class="tab-pane teacher-only">
        <div class="card">
          <div class="card-header">
            <h3 style="margin: 0;">My Created Quizzes</h3>
          </div>
          <div class="card-body">
            <div id="myQuizzesContainer">
              <!-- Quizzes will be dynamically added here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PREVIEW MODAL -->
  <div class="preview-modal" id="previewModal">
    <div class="preview-content">
      <div class="preview-header">
        <h3 id="previewQuizTitle">Quiz Preview</h3>
        <button class="close-btn" id="closePreview">&times;</button>
      </div>
      <div class="preview-body" id="previewQuizBody">
        <!-- Preview content will be added here -->
      </div>
    </div>
  </div>

  <script>
    // Function to show initial validation errors
    function showInitialValidationErrors() {
      // Show error for quiz title
      var titleMsg = document.getElementById("quizTitle_error");
      if (titleMsg) {
        titleMsg.style.color = "red";
        titleMsg.innerHTML = "Quiz title must contain at least 3 characters";
      }
      
      // Show error for category
      var categoryMsg = document.getElementById("quizCategory_error");
      if (categoryMsg) {
        categoryMsg.style.color = "red";
        categoryMsg.innerHTML = "Please select a category";
      }
      
      // Show error for grade level
      var gradeMsg = document.getElementById("quizGrade_error");
      if (gradeMsg) {
        gradeMsg.style.color = "red";
        gradeMsg.innerHTML = "Please select a grade level";
      }
      
      // Show error for passing grade
      var passingMsg = document.getElementById("passingGrade_error");
      if (passingMsg) {
        passingMsg.style.color = "red";
        passingMsg.innerHTML = "Passing grade must be between 1 and 100";
      }
      
      // Show error for questions
      var questionsMsg = document.getElementById("questions_error");
      if (questionsMsg) {
        questionsMsg.style.color = "red";
        questionsMsg.innerHTML = "Please add at least one question";
      }
    }
    
    // Initialize when page loads
    window.onload = function() {
      // Fetch quizzes from server
      fetchAllQuizzes();
      displayMyQuizzes();
      // Fetch teacher statistics (e.g., Average Score)
      fetchTeacherStats();
      setupTabSwitching();
      setupRoleSwitching();
      
      // Initialize form with one question
      addNewQuestion();
      
      // Show initial validation errors
      showInitialValidationErrors();
    };

    // Fetch teacher stats and update cards (Average Score)
    function fetchTeacherStats() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=getStats', true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              var temp = document.createElement('div');
              temp.innerHTML = xhr.responseText;
              var stats = temp.querySelectorAll('.stat');
              for (var i = 0; i < stats.length; i++) {
                var labelEl = stats[i].querySelector('.text-muted');
                var valueEl = stats[i].querySelector('.h4');
                if (!labelEl || !valueEl) continue;
                var label = labelEl.textContent || '';
                var value = (valueEl.textContent || '').trim();
                if (label.indexOf('Average Score') !== -1) {
                  var as = document.getElementById('averageScore');
                  if (as) as.textContent = value.match(/%$/) ? value : (value + '%');
                }
              }
            } catch (e) {
              console.warn('Failed to parse teacher stats:', e);
            }
          } else {
            console.warn('Could not fetch teacher stats. Status:', xhr.status);
          }
        }
      };
      xhr.send();
    }
    
    function fetchAllQuizzes() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=getAllQuizzes', true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          try {
            // Update stats with count from server response
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = xhr.responseText;
            var activeBadges = tempDiv.querySelectorAll('.badge.bg-success');
            document.getElementById('availableQuizzes').textContent = activeBadges.length;
            
            displayBrowseQuizzes(xhr.responseText);
          } catch (e) {
            console.error('Error fetching quizzes:', e);
          }
        }
      };
      xhr.send();
    }

    function setupTabSwitching() {
      // Tab switching
      var tabs = document.getElementById('mainTabs').getElementsByTagName('a');
      for (var i = 0; i < tabs.length; i++) {
        tabs[i].onclick = function(e) {
          e = e || window.event;
          if (e.preventDefault) {
            e.preventDefault();
          } else {
            e.returnValue = false;
          }
          
          // Remove active class from all tabs
          for (var j = 0; j < tabs.length; j++) {
            tabs[j].className = tabs[j].className.replace(' active', '');
          }
          
          // Hide all tab panes
          var panes = document.getElementsByClassName('tab-pane');
          for (var k = 0; k < panes.length; k++) {
            panes[k].className = panes[k].className.replace(' active', '');
          }
          
          // Add active class to clicked tab
          this.className += ' active';
          
          // Show corresponding tab pane
          var targetId = this.getAttribute('href').substring(1);
          document.getElementById(targetId).className += ' active';
          
          // Refresh quiz lists when switching to those tabs
          if (targetId === 'my-quizzes') {
            displayMyQuizzes();
          } else if (targetId === 'browse-quizzes') {
            fetchAllQuizzes();
          }
        };
      }
    }
    
    function setupRoleSwitching() {
      // Role switching
      document.getElementById('userRole').onclick = function() {
        var currentRole = this.innerHTML;
        if (currentRole === 'Teacher') {
          this.innerHTML = 'Student';
          var teacherElements = document.getElementsByClassName('teacher-only');
          for (var i = 0; i < teacherElements.length; i++) {
            teacherElements[i].className += ' hidden';
          }
        } else {
          this.innerHTML = 'Teacher';
          var teacherElements = document.getElementsByClassName('teacher-only');
          for (var i = 0; i < teacherElements.length; i++) {
            teacherElements[i].className = teacherElements[i].className.replace(' hidden', '');
          }
        }
      };
    }
    
    function displayMyQuizzes() {
      var container = document.getElementById('myQuizzesContainer');
      
      // Fetch teacher's quizzes from server
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=getMyQuizzes', true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          if (xhr.responseText.includes('No quizzes found')) {
            container.innerHTML = '<div class="empty-state" id="emptyMyQuizzes">' +
                '<i class="fas fa-file-alt"></i>' +
                '<h4>No quizzes created yet</h4>' +
                '<p>Create your first quiz to see it listed here</p>' +
                '<button class="btn-primary" onclick="switchToCreateTab()">Create Quiz</button>' +
              '</div>';
          } else {
            container.innerHTML = '<div class="card"><div class="card-body"><table class="table"><thead><tr><th>Title</th><th>Category</th><th>Questions</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>' + xhr.responseText + '</tbody></table></div></div>';
            
            // Update my quizzes count
            var rows = container.querySelectorAll('tbody tr');
            document.getElementById('myQuizzesCount').textContent = rows.length;
          }
        }
      };
      xhr.send();
    }
    
    function displayBrowseQuizzes(htmlContent) {
      var container = document.getElementById('browseQuizzesContainer');
      
      if (htmlContent.includes('No quizzes found')) {
        container.innerHTML = '<div class="empty-state">' +
            '<i class="fas fa-search"></i>' +
            '<h4>No quizzes available</h4>' +
            '<p>Create a quiz to see it listed here</p>' +
          '</div>';
      } else {
        container.innerHTML = '<div class="card"><div class="card-body"><table class="table"><thead><tr><th>Title</th><th>Teacher</th><th>Category</th><th>Grade</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>' + 
          htmlContent + '</tbody></table></div></div>';
      }
    }
    
    function getCategoryName(category) {
      var categories = {
        'math': 'Mathematics',
        'science': 'Science',
        'english': 'English',
        'social-studies': 'Social Studies',
        'history': 'History',
        'geography': 'Geography',
        'biology': 'Biology',
        'chemistry': 'Chemistry',
        'physics': 'Physics',
        'earth-science': 'Earth Science',
        'environmental-science': 'Environmental Science',
        'astronomy': 'Astronomy',
        'art': 'Art',
        'music': 'Music',
        'other': 'Other'
      };
      
      return categories[category] || category;
    }
    
    function switchToCreateTab() {
      document.querySelector('a[href="#create-quiz"]').click();
    }
    
    function previewQuiz(quizId) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=preview&id=' + encodeURIComponent(quizId), true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            var body = document.getElementById('previewQuizBody');
            if (body) {
              body.innerHTML = xhr.responseText;
              var modal = document.getElementById('previewModal');
              if (modal) {
                modal.style.display = 'block';
              }
            }
          } else {
            alert('Error loading quiz preview. Status: ' + xhr.status);
            console.error('Preview error:', xhr.status, xhr.responseText);
          }
        }
      };
      xhr.send();
    }

    function editQuiz(quizId) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=getQuizFormData&id=' + encodeURIComponent(quizId), true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4 && xhr.status === 200) {
          var params = new URLSearchParams(xhr.responseText);
          document.getElementById('quizId').value = params.get('quiz_id') || '';
          document.getElementById('quizTitle').value = params.get('title') || '';
          document.getElementById('quizCategory').value = params.get('category') || '';
          document.getElementById('quizGrade').value = params.get('gradeLevel') || '';
          document.getElementById('quizDescription').value = params.get('description') || '';
          document.getElementById('passingGrade').value = params.get('passing_grade') || '';
          document.getElementById('timeLimit').value = params.get('time_limit') || '';
          
          // Set status radio button
          var status = params.get('status') || 'active';
          if (status === 'active') {
            document.getElementById('statusActive').checked = true;
          } else if (status === 'draft') {
            document.getElementById('statusDraft').checked = true;
          } else if (status === 'inactive') {
            document.getElementById('statusInactive').checked = true;
          }
          
          var qc = document.getElementById('questionsContainer');
          qc.innerHTML = '';
          questionCount = 0;
          var index = 0;
          while (params.has('questions['+index+'][text]')) {
            addNewQuestion();
            var qEl = document.getElementById('question-' + (index+1));
            var qTextInput = qEl.querySelector('.question-text');
            if (qTextInput) {
              qTextInput.value = params.get('questions['+index+'][text]') || '';
            }
            var opts = qEl.querySelectorAll('.option-input');
            for (var j=0; j<opts.length; j++) {
              var t = params.get('questions['+index+'][options]['+j+'][text]') || '';
              opts[j].value = t;
              var isCorrect = params.get('questions['+index+'][options]['+j+'][is_correct]') === '1';
              if (isCorrect) {
                var letters = ['A','B','C','D'];
                var letter = letters[j] || 'A';
                setCorrectAnswer((index+1).toString(), letter);
              }
            }
            index++;
          }
          
          // Add remove buttons to all questions in edit mode
          var allQuestions = document.querySelectorAll('.question-item');
          allQuestions.forEach(function(qEl, idx) {
            var questionId = idx + 1;
            var header = qEl.querySelector('.question-header');
            if (header && !qEl.querySelector('.remove-question')) {
              var removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'btn-danger btn-sm remove-question';
              removeBtn.id = 'remove-question-' + questionId;
              removeBtn.style.cssFloat = 'right';
              removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
              removeBtn.onclick = function() {
                removeQuestion(questionId);
              };
              header.appendChild(removeBtn);
            }
          });
          
          document.querySelector('a[href="#create-quiz"]').click();
          document.getElementById('quizForm').action = 'http://localhost/quizzes2/quizzes2/quiz/controller/quizcontroller.php?action=edit';
        }
      };
      xhr.send();
    }
    
    function deleteMyQuiz(quizId) {
      if (confirm('Are you sure you want to delete this quiz?')) {
        requestDeleteQuiz(quizId);
      }
    }
    function deleteQuiz(quizId) {
      deleteMyQuiz(quizId);
    }
    
    function deleteQuizFromBrowse(quizId) {
      if (confirm('Are you sure you want to delete this quiz?')) {
        requestDeleteQuiz(quizId);
      }
    }
    
    function requestDeleteQuiz(quizId) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '../controller/quizcontroller.php?action=delete', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            alert('Quiz deleted successfully');
            // Reload the quizzes
            fetchAllQuizzes();
            displayMyQuizzes();
          } else {
            alert('Error deleting quiz: ' + xhr.responseText);
          }
        }
      };
      xhr.send('quiz_id=' + encodeURIComponent(quizId));
    }
    
    // Quiz Form Functionality
    var questionCount = 0;
    
    function addNewQuestion() {
      questionCount++;
      var questionHTML = '' +
      '<div class="question-item" id="question-' + questionCount + '">' +
      '<div class="question-header">' +
      '<div class="section-subheader">Question ' + questionCount + '</div>' +
      (questionCount > 1 ? '<button type="button" class="btn-danger btn-sm remove-question" id="remove-question-' + questionCount + '" style="float: right;"><i class="fas fa-trash"></i> Remove</button>' : '') +
      '<div class="clearfix"></div>' +
      '</div>' +
      '<div class="form-group">' +
          '<label class="form-label"><strong>Question Text *</strong></label>' +
          '<input type="text" class="form-control question-text" name="questions[' + questionCount + '][text]" placeholder="Enter your question">' +
          '<small class="text-muted">Must be at least 1 character</small>' + 
      '</div>' +
      '<div class="option-group">' +
          '<label class="form-label"><strong>Options *</strong></label>';
  
      var optionLetters = ['A', 'B', 'C', 'D'];
      for (var i = 0; i < optionLetters.length; i++) {
          var letter = optionLetters[i];
          questionHTML += '' +
          '<div class="option-row">' +
          '<div class="option-label">' + letter + '</div>' +
          '<input type="text" class="form-control option-input option-' + letter.toLowerCase() + '" name="questions[' + questionCount + '][options][' + i + '][text]" placeholder="Option ' + letter + '">' +
          '<div class="correct-option">' +
          '<button type="button" class="btn-outline-primary btn-sm set-correct" id="set-correct-Q' + questionCount + '-O' + letter + '">' +
          'Set Correct' +
          '</button>' +
          '<input type="hidden" class="correct-input" name="questions[' + questionCount + '][options][' + i + '][is_correct]" value="0">' +
          '</div>' +
          '<div class="clearfix"></div>' +
          '</div>';
      }
  
      questionHTML += '' +
      '</div>' +
      '<div class="correct-answer-display">' +
          '<small class="text-muted">Correct answer: <span id="correct-answer-' + questionCount + '">Not set</span></small>' +
      '</div>' +
      '</div>';
  
      var container = document.getElementById('questionsContainer');
      var newQuestion = document.createElement('div');
      newQuestion.innerHTML = questionHTML;
      container.appendChild(newQuestion);
  
      // Add event listeners for the new question
      addQuestionEventListeners(questionCount);
      validateQuestions();
    }
    
    function addQuestionEventListeners(questionId) {
      var questionElement = document.getElementById('question-' + questionId);
      if (!questionElement) return;
  
      // Add event listeners to set-correct buttons
      var setCorrectButtons = questionElement.getElementsByClassName('set-correct');
      for (var j = 0; j < setCorrectButtons.length; j++) {
          setCorrectButtons[j].onclick = function() {
              var parts = this.id.split('-');
              var qPart = parts[2] || '';
              var oPart = parts[3] || '';
              var qid = qPart.replace(/^Q/, '');
              var opt = oPart.replace(/^O/, '');
              setCorrectAnswer(qid, opt);
          };
      }
  
      // Add event listener to remove button
      var removeBtn = questionElement.getElementsByClassName('remove-question')[0];
      if (removeBtn) {
          removeBtn.onclick = function() {
              var qid = this.id.replace('remove-question-', '');
              removeQuestion(qid);
          };
      }
    }
    
    function setCorrectAnswer(questionId, optionLetter) {
      var questionElement = document.getElementById('question-' + questionId);
      if (!questionElement) return;
  
      // Reset all options for this question
      var setCorrectButtons = questionElement.getElementsByClassName('set-correct');
      var correctInputs = questionElement.getElementsByClassName('correct-input');
  
      for (var i = 0; i < setCorrectButtons.length; i++) {
          var btn = setCorrectButtons[i];
          btn.innerHTML = 'Set Correct';
          btn.className = 'btn-outline-primary btn-sm set-correct';
  
          if (correctInputs[i]) {
              correctInputs[i].value = '0';
          }
      }
  
      // Set this option as correct
      var correctButton = document.getElementById('set-correct-Q' + questionId + '-O' + optionLetter);
      if (correctButton) {
          correctButton.innerHTML = 'Correct âœ“';
          correctButton.className = 'btn-success btn-sm set-correct';
  
          var correctHiddenInput = correctButton.nextElementSibling;
          if (correctHiddenInput && correctHiddenInput.type === 'hidden') {
              correctHiddenInput.value = '1';
          }
  
          // Update display
          var correctAnswerDisplay = document.getElementById('correct-answer-' + questionId);
          if (correctAnswerDisplay) {
              correctAnswerDisplay.innerHTML = 'Option ' + optionLetter;
              correctAnswerDisplay.style.color = 'green';
              correctAnswerDisplay.style.fontWeight = 'bold';
          }
      }
  
      validateQuestions();
    }
    
    function removeQuestion(questionId) {
      var questionElement = document.getElementById('question-' + questionId);
      if (questionElement && questionElement.parentNode) {
          questionElement.parentNode.removeChild(questionElement);
          renumberQuestions();
          validateQuestions();
      }
    }
    
    function renumberQuestions() {
      var questions = document.getElementsByClassName('question-item');
      questionCount = questions.length;
  
      for (var i = 0; i < questions.length; i++) {
          var questionId = i + 1;
          questions[i].id = 'question-' + questionId;
  
          var header = questions[i].getElementsByClassName('section-subheader')[0];
          if (header) {
              header.innerHTML = 'Question ' + questionId;
          }
  
          // Update all form field names with new question number
          var questionText = questions[i].getElementsByClassName('question-text')[0];
          if (questionText) {
              questionText.name = 'questions[' + questionId + '][text]';
          }
  
          var optionLetters = ['A','B','C','D'];
          var optionInputs = questions[i].getElementsByClassName('option-input');
          var correctInputs = questions[i].getElementsByClassName('correct-input');
          
          for (var j = 0; j < optionInputs.length; j++) {
              optionInputs[j].name = 'questions[' + questionId + '][options][' + j + '][text]';
              correctInputs[j].name = 'questions[' + questionId + '][options][' + j + '][is_correct]';
          }
  
          // Update button IDs
          for (var ol = 0; ol < optionLetters.length; ol++) {
              var letter = optionLetters[ol];
              var inputs = questions[i].getElementsByClassName('option-' + letter.toLowerCase());
              if (inputs.length > 0) {
                  var optionRow = inputs[0].parentNode;
                  var btns = optionRow.getElementsByClassName('set-correct');
                  if (btns.length > 0) {
                      btns[0].id = 'set-correct-Q' + questionId + '-O' + letter;
                  }
              }
          }
  
          var removeButtons = questions[i].getElementsByClassName('remove-question');
          for (var k = 0; k < removeButtons.length; k++) {
              var removeBtn = removeButtons[k];
              removeBtn.id = 'remove-question-' + questionId;
          }
  
          // Update correct answer display ID
          var correctDisplay = questions[i].getElementsByClassName('correct-answer-display')[0];
          if (correctDisplay) {
              var span = correctDisplay.getElementsByTagName('span')[0];
              if (span) {
                  span.id = 'correct-answer-' + questionId;
              }
          }
      }
    }
    
    // Validation flags
    var quizTitle = false;
    var quizCategory = false;
    var quizGrade = false;
    var passingGrade = false;
    var questionsValid = false;
    
    // Real-time verification of quiz title
    document.getElementById("quizTitle").onkeyup = function () {
        var value = this.value.replace(/^\s+|\s+\$/g, '');
        var msg = document.getElementById("quizTitle_error");
  
        if (value.length >= 3) {
            msg.style.color = "green";
            msg.innerHTML = "Valid";
            quizTitle = true;
        } else {
            msg.style.color = "red";
            msg.innerHTML = "Quiz title must contain at least 3 characters";
            quizTitle = false;
        }
    };
    
    // Verification of category on change
    document.getElementById("quizCategory").onchange = function () {
        var value = this.value;
        var msg = document.getElementById("quizCategory_error");
  
        if (value !== "") {
            msg.style.color = "green";
            msg.innerHTML = "Valid";
            quizCategory = true;
        } else {
            msg.style.color = "red";
            msg.innerHTML = "Please select a category";
            quizCategory = false;
        }
    };
    
    // Verification of grade level on change
    document.getElementById("quizGrade").onchange = function () {
        var value = this.value;
        var msg = document.getElementById("quizGrade_error");
  
        if (value !== "") {
            msg.style.color = "green";
            msg.innerHTML = "Valid";
            quizGrade = true;
        } else {
            msg.style.color = "red";
            msg.innerHTML = "Please select a grade level";
            quizGrade = false;
        }
    };
    
    // Real-time verification of passing grade
    document.getElementById("passingGrade").onkeyup = function () {
        var value = parseInt(this.value, 10);
        var msg = document.getElementById("passingGrade_error");
  
        if (!isNaN(value) && value >= 1 && value <= 100) {
            msg.style.color = "green";
            msg.innerHTML = "Valid";
            passingGrade = true;
        } else {
            msg.style.color = "red";
            msg.innerHTML = "Passing grade must be between 1 and 100";
            passingGrade = false;
        }
    };
    
    // Question validation function
    function validateQuestions() {
        var questions = document.getElementsByClassName('question-item');
        var msg = document.getElementById("questions_error");
  
        if (questions.length === 0) {
            msg.style.color = "red";
            msg.innerHTML = "Please add at least one question";
            questionsValid = false;
            return;
        }
  
        var allQuestionsHaveCorrectAnswer = true;
        var allQuestionsHaveText = true;
        var allOptionsFilled = true;
  
        for (var i = 0; i < questions.length; i++) {
            var question = questions[i];
            var questionText = question.getElementsByClassName('question-text')[0].value.replace(/^\s+|\s+\$/g, '');
            var hasCorrectAnswer = false;
  
            // Check for correct answer
            var correctInputs = question.getElementsByClassName('correct-input');
            for (var j = 0; j < correctInputs.length; j++) {
                if (correctInputs[j].value === '1') {
                    hasCorrectAnswer = true;
                    break;
                }
            }
  
            // Check question text
            if (questionText.length < 1) {
                allQuestionsHaveText = false;
                question.getElementsByClassName('question-text')[0].style.border = "1px solid red";
            } else {
                question.getElementsByClassName('question-text')[0].style.border = "1px solid #ddd";
            }
  
            // Check correct answer
            if (!hasCorrectAnswer) {
                allQuestionsHaveCorrectAnswer = false;
                question.style.border = "2px solid red";
            } else {
                question.style.border = "1px solid #e0e0e0";
            }
  
            // Check options
            var optionsFilled = true;
            var optionInputs = question.getElementsByClassName('option-input');
            for (var k = 0; k < optionInputs.length; k++) {
                var optionValue = optionInputs[k].value.replace(/^\s+|\s+$/g, '');
                if (optionValue === "") {
                    optionsFilled = false;
                    optionInputs[k].style.border = "1px solid red";
                } else {
                    optionInputs[k].style.border = "1px solid #ddd";
                }
            }
  
            if (!optionsFilled) allOptionsFilled = false;
        }
  
        if (!allQuestionsHaveText) {
            msg.style.color = "red";
            msg.innerHTML = "All questions must have text (min. 1 character)";
            questionsValid = false;
        } else if (!allQuestionsHaveCorrectAnswer) {
            msg.style.color = "red";
            msg.innerHTML = "Please set correct answer for all questions";
            questionsValid = false;
        } else if (!allOptionsFilled) {
            msg.style.color = "red";
            msg.innerHTML = "Please fill all options for each question";
            questionsValid = false;
        } else {
            msg.style.color = "green";
            msg.innerHTML = "Valid (" + questions.length + " questions)";
            questionsValid = true;
        }
    }
    
    // Submit quiz form via traditional form submission
    function submitQuizForm() {
        validateQuestions();
        if (!(quizTitle && quizCategory && quizGrade && passingGrade && questionsValid)) {
            var formMessage = document.getElementById('form_message');
            if (formMessage) { formMessage.style.color = 'red'; formMessage.innerHTML = 'Please fix all validation errors before submitting!'; }
            else { alert('Please fix all validation errors before submitting!'); }
            return;
        }

        var isEdit = !!document.getElementById('quizId').value;
        var actionUrl = isEdit
          ? '../controller/quizcontroller.php?action=edit'
          : '../controller/quizcontroller.php?action=create';

        var params = new URLSearchParams();
        params.set('ajax', '1');
        params.set('quiz_id', document.getElementById('quizId').value || '');
        params.set('title', document.getElementById('quizTitle').value);
        params.set('category', document.getElementById('quizCategory').value);
        params.set('gradeLevel', document.getElementById('quizGrade').value);
        params.set('description', document.getElementById('quizDescription').value || '');
        
        // Get selected status from radio buttons
        var statusRadio = document.querySelector('input[name="status"]:checked');
        params.set('status', statusRadio ? statusRadio.value : 'active');
        
        params.set('passing_grade', document.getElementById('passingGrade').value || '70');
        params.set('time_limit', document.getElementById('timeLimit').value || '0');

        var questions = document.getElementsByClassName('question-item');
        for (var i = 0; i < questions.length; i++) {
            var qEl = questions[i];
            var qText = qEl.querySelector('.question-text').value;
            params.set('questions[' + i + '][text]', qText);
            var optionInputs = qEl.querySelectorAll('.option-input');
            var correctInputs = qEl.querySelectorAll('.correct-input');
            for (var j = 0; j < optionInputs.length; j++) {
                params.set('questions[' + i + '][options][' + j + '][text]', optionInputs[j].value);
                var isC = (correctInputs[j] && correctInputs[j].value === '1') ? '1' : '0';
                params.set('questions[' + i + '][options][' + j + '][is_correct]', isC);
            }
        }

        var xhr = new XMLHttpRequest();
        xhr.open('POST', actionUrl, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onreadystatechange = function(){
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              var text = xhr.responseText || '';
              var qid = '';
              if (text.indexOf('quiz_id=') === 0) { qid = text.split('=')[1]; }
              alert(isEdit ? 'Quiz updated successfully' : 'Quiz created successfully');
              
              // Reset form after successful save
              document.getElementById('quizForm').reset();
              document.getElementById('quizId').value = '';
              document.getElementById('questionsContainer').innerHTML = '';
              questionCount = 0;
              addNewQuestion();
              
              // Reset form action to create
              document.getElementById('quizForm').action = '../controller/quizcontroller.php?action=create';
              
              // Reset validation flags
              quizTitle = false;
              quizCategory = false;
              quizGrade = false;
              passingGrade = false;
              questionsValid = false;
              
              // Reset validation messages to show errors again
              showInitialValidationErrors();
              
              fetchAllQuizzes();
              displayMyQuizzes();
              
          // Switch to My Quizzes tab to see the result
              document.querySelector('a[href="#my-quizzes"]').click();
            } else {
              alert('Error saving quiz');
            }
          }
        };
        xhr.send(params.toString());
    }
    
    // Initialize form buttons
    document.getElementById('addQuestionBtn').onclick = addNewQuestion;
    document.getElementById('submitQuizBtn').onclick = submitQuizForm;
    document.getElementById('quizForm').addEventListener('submit', function(e){ e.preventDefault(); submitQuizForm(); });
    document.getElementById('cancelQuizBtn').onclick = function() {
        if (confirm('Are you sure you want to cancel? All unsaved changes will be lost.')) {
            window.location.reload();
        }
    };
    
    // Preview modal functionality
    document.getElementById('closePreview').onclick = function() {
      document.getElementById('previewModal').style.display = 'none';
    };
    
    window.onclick = function(e) {
      if (e.target == document.getElementById('previewModal')) {
        document.getElementById('previewModal').style.display = 'none';
      }
    };

    window.editQuiz = editQuiz;
    window.previewQuiz = previewQuiz;
    window.deleteQuiz = deleteQuiz;
    window.deleteMyQuiz = deleteMyQuiz;
  </script>
</body>
</html>
