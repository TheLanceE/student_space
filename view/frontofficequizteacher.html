  <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>EduMind+ | Quizzes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f7fb; margin: 0; padding: 0; }
    .navbar { background-color: #4361ee; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar-brand { color: white; font-weight: bold; font-size: 24px; text-decoration: none; margin-left: 20px; }
    .nav-links { display: block; list-style: none; margin: 0; padding: 0; margin-left: 30px; float: left; }
    .nav-links li { float: left; margin-right: 20px; }
    .nav-links a { color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; display: block; }
    .nav-links a.active { background-color: rgba(255,255,255,0.2); }
    .user-role { background: rgba(255,255,255,0.2); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-left: 10px; cursor: pointer; float: left; }
    .container { width: 1200px; margin: 0 auto; padding: 20px; }
    .welcome-section { background: #4361ee; color: white; border-radius: 10px; padding: 30px; margin-bottom: 30px; }
    .card { background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; padding: 20px; border: 1px solid #e0e0e0; }
    .stats-card { text-align: center; padding: 20px 15px; }
    .stats-card i { font-size: 32px; margin-bottom: 15px; color: #4361ee; }
    .stats-card .number { font-size: 32px; font-weight: bold; margin: 10px 0; }
    .quiz-card { position: relative; height: auto; margin-bottom: 20px; }
    .quiz-badge { position: absolute; top: 15px; right: 15px; background: #4361ee; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 12px; }
    .btn-primary { background: #4361ee; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-success { background: #4cc9f0; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-outline-primary { background: transparent; color: #4361ee; border: 1px solid #4361ee; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
    .btn-danger { background: #e63946; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
    .form-select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
    .hidden { display: none; }
    .nav-tabs { border-bottom: 2px solid #e0e0e0; display: block; list-style: none; padding: 0; margin: 0; }
    .nav-tabs li { float: left; margin-right: 10px; }
    .nav-tabs a { padding: 12px 25px; text-decoration: none; color: #666; font-weight: bold; border-bottom: 3px solid transparent; display: block; }
    .nav-tabs a.active { color: #4361ee; border-bottom: 3px solid #4361ee; }
    .tab-content { padding: 20px 0; clear: both; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    .questions-section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0; }
    .question-item { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #e0e0e0; }
    .question-header { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0; overflow: hidden; }
    .option-group { margin-top: 15px; }
    .option-row { margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #e0e0e0; overflow: hidden; }
    .option-label { width: 30px; font-weight: bold; color: #4361ee; float: left; margin-right: 10px; }
    .option-input { width: 65%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; float: left; }
    .correct-option { width: 30%; text-align: center; float: right; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .correct-answer-display { padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #4cc9f0; margin-top: 10px; }
    .form-text { font-size: 12px; margin-top: 4px; color: #e63946; display: block; }
    .error-message { color: #e63946; font-size: 12px; margin-top: 5px; }
    .success-message { color: #2ecc71; font-size: 14px; margin-top: 10px; }
    .teacher-badge { background: #4cc9f0; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px; }
    .clearfix:after { content: ""; display: table; clear: both; }
    .clearfix { zoom: 1; }
    .row { overflow: hidden; margin: 0 -10px; }
    .col-md-3, .col-md-4, .col-md-6, .col-md-8 { float: left; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; padding: 0 10px; }
    .col-md-3 { width: 25%; }
    .col-md-4 { width: 33.333%; }
    .col-md-6 { width: 50%; }
    .col-md-8 { width: 66.666%; }
    .text-end { text-align: right; }
    .section-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
    .section-subheader { font-size: 16px; font-weight: bold; margin: 15px 0 10px 0; color: #555; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    .quiz-list { overflow: hidden; }
    .empty-state { text-align: center; padding: 40px; color: #666; }
    .empty-state i { font-size: 48px; margin-bottom: 15px; color: #ddd; }
    .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .preview-content { position: absolute; top: 50%; left: 50%; margin-left: -400px; margin-top: -45vh; background: white; border-radius: 10px; width: 800px; max-height: 90vh; overflow-y: auto; }
    .preview-header { padding: 20px; border-bottom: 1px solid #e0e0e0; overflow: hidden; }
    .preview-body { padding: 20px; }
    .preview-question { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .preview-options { margin-top: 10px; }
    .preview-option { padding: 10px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #e0e0e0; }
    .preview-option.correct { background: #e8f5e8; border-color: #2ecc71; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; float: right; }
    .badge { display: inline-block; padding: 3px 8px; font-size: 12px; font-weight: bold; border-radius: 4px; }
    .bg-success { background: #2ecc71; color: white; }
    .bg-secondary { background: #95a5a6; color: white; }
    .bg-primary { background: #4361ee; color: white; }
  </style>
</head>
<body>
  <!-- NAVIGATION BAR -->
  <div class="navbar">
    <div class="container">
      <div class="clearfix">
        <a href="#" class="navbar-brand">
          <i class="fas fa-graduation-cap"></i> EduMind
        </a>
        <ul class="nav-links">
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="#" class="active">Quizzes</a></li>
          <li><a href="profile.html">Profile</a></li>
        </ul>
        <div style="float: right;">
          <span class="user-role" id="userRole">Teacher</span>
          <button class="btn-outline-primary" style="color: white; border-color: white; margin-left: 10px;">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="container">
    <!-- WELCOME SECTION -->
    <div class="welcome-section">
      <div class="row">
        <div class="col-md-8">
          <h1 style="margin: 0 0 10px 0;">Welcome to EduMind Quizzes</h1>
          <p style="margin: 0; font-size: 16px;">Create and manage quizzes for your students.</p>
        </div>
        <div class="col-md-4 text-end">
          <div style="background: white; color: #4361ee; border-radius: 50%; width: 80px; height: 80px; display: inline-block; text-align: center; line-height: 80px;">
            <i class="fas fa-brain" style="font-size: 32px;"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- STATS CARDS -->
    <div class="row" style="margin-bottom: 20px;">
      <div class="col-md-4">
        <div class="card stats-card">
          <i class="fas fa-list-alt"></i>
          <div class="number" id="availableQuizzes">0</div>
          <div>Available Quizzes</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stats-card">
          <i class="fas fa-trophy"></i>
          <div class="number" id="averageScore">0%</div>
          <div>Average Score</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stats-card">
          <i class="fas fa-plus-circle"></i>
          <div class="number" id="myQuizzesCount">0</div>
          <div>My Created Quizzes</div>
        </div>
      </div>
    </div>

    <!-- TABS SECTION -->
    <ul class="nav-tabs" id="mainTabs">
      <li class="teacher-only"><a href="#browse-quizzes" class="active">Browse Quizzes</a></li>
      <li class="teacher-only"><a href="#create-quiz">Create Quiz</a></li>
      <li class="teacher-only"><a href="#my-quizzes">My Quizzes</a></li>
    </ul>
    
    <div class="tab-content">
      <!-- TAB 1: BROWSE QUIZZES -->
      <div id="browse-quizzes" class="tab-pane active teacher-only">
        <h2 style="margin-bottom: 20px;">Available Quizzes</h2>
        <div style="margin-bottom: 20px;">
          <input type="text" id="searchBrowseQuizzes" class="form-control" placeholder="Search quizzes by title..." style="max-width: 400px;">
        </div>
        <div class="quiz-list" id="browseQuizzesContainer">
          <!-- Quizzes will be dynamically added here -->
        </div>
      </div>
      
      <!-- TAB 2: CREATE QUIZ -->
      <div id="create-quiz" class="tab-pane teacher-only">
        <div class="card">
          <div class="card-header">
            <h3 style="margin: 0;">Create New Quiz</h3>
          </div>
          <div class="card-body">
            <!-- FIXED FORM ACTION -->
            <!-- In the Create Quiz tab -->
              <form id="quizForm" method="POST" action="../controller/quizcontroller.php?action=create">
                <input type="hidden" id="quizId" name="quiz_id" value="">
              <!-- QUIZ BASIC INFORMATION -->
              <div class="section-header">Quiz Information</div>
              
              <!-- Quiz Title -->
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Quiz Title *</label>
                    <input type="text" class="form-control" id="quizTitle" name="title" placeholder="Enter quiz title">
                    <small id="quizTitle_error" class="form-text"></small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select class="form-select" id="quizCategory" name="category">
                      <option value="">Select category</option>
                      <optgroup label="Core Subjects">
                        <option value="math">Mathematics</option>
                        <option value="science">Science</option>
                        <option value="english">English Language Arts</option>
                        <option value="social-studies">Social Studies</option>
                        <option value="history">History</option>
                        <option value="geography">Geography</option>
                      </optgroup>
                      <optgroup label="Science Specializations">
                        <option value="biology">Biology</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="physics">Physics</option>
                        <option value="earth-science">Earth Science</option>
                        <option value="environmental-science">Environmental Science</option>
                        <option value="astronomy">Astronomy</option>
                      </optgroup>
                      <optgroup label="Other">
                        <option value="art">Art</option>
                        <option value="music">Music</option>
                        <option value="other">Other</option>
                      </optgroup>
                    </select>
                    <small id="quizCategory_error" class="form-text"></small>
                  </div>
                </div>
              </div>
              
              <!-- Grade Level and Time Limit -->
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Grade Level *</label>
                    <select class="form-select" id="quizGrade" name="gradeLevel">
                      <option value="">Select grade</option>
                      <optgroup label="Elementary School">
                        <option value="1">Grade 1</option>
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                      </optgroup>
                      <optgroup label="Middle School">
                        <option value="6">Grade 6</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                      </optgroup>
                      <optgroup label="High School">
                        <option value="9">Grade 9 (Freshman)</option>
                        <option value="10">Grade 10 (Sophomore)</option>
                        <option value="11">Grade 11 (Junior)</option>
                        <option value="12">Grade 12 (Senior)</option>
                      </optgroup>
                    </select>
                    <small id="quizGrade_error" class="form-text"></small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Time Limit (minutes)</label>
                    <input type="text" class="form-control" id="timeLimit" name="time_limit" placeholder="e.g., 30">
                  </div>
                </div>
              </div>
              <!-- Passing Grade and Status -->
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Passing Grade (%) *</label>
                    <input type="text" class="form-control" id="passingGrade" name="passing_grade" placeholder="e.g., 70">
                    <small id="passingGrade_error" class="form-text"></small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Quiz Status *</label>
                    <div style="margin-top: 8px;">
                      <input type="radio" name="status" id="statusActive" value="active" checked="checked">
                      <label for="statusActive">Active</label>
                      <input type="radio" name="status" id="statusDraft" value="draft" style="margin-left: 15px;">
                      <label for="statusDraft">Draft</label>
                      <input type="radio" name="status" id="statusInactive" value="inactive" style="margin-left: 15px;">
                      <label for="statusInactive">Inactive</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Description -->
              <div class="form-group">
                <label class="form-label">Description</label>
                <div style="position: relative;">
                  <textarea class="form-control" id="quizDescription" name="description" rows="3" placeholder="Enter quiz description (optional)" style="padding-right: 65px;"></textarea>
                  <button type="button" id="voiceBtn" onclick="startVoiceRecognition()" style="position: absolute; right: 8px; top: 8px; background: #4CAF50; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; padding: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: all 0.2s ease;" title="Click to speak">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white" style="margin-left: 3px;">
                      <polygon points="5,3 5,21 21,12"></polygon>
                    </svg>
                  </button>
                </div>
                <small id="voiceStatus" style="color: #666; display: none;"></small>
              </div>
              
              <!-- AI GENERATION SECTION -->
              <div style="background: #f0f7ff; border: 2px solid #4361ee; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                  <i class="fas fa-magic" style="color: #4361ee; font-size: 24px; margin-right: 10px;"></i>
                  <div>
                    <div style="font-weight: bold; font-size: 16px; color: #333;">AI Question Generator</div>
                    <div style="font-size: 12px; color: #666;">Let AI create questions based on your quiz details</div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Number of Questions to Generate</label>
                      <input type="number" class="form-control" id="aiQuestionCount" value="5" min="1" max="20" placeholder="e.g., 5">
                    </div>
                  </div>
                  <div class="col-md-6" style="display: flex; align-items: flex-end;">
                    <button type="button" class="btn-primary" id="generateQuestionsBtn" onclick="generateAIQuestions()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100%;">
                      <i class="fas fa-magic"></i> Generate Questions with AI
                    </button>
                  </div>
                </div>
                <div id="aiGenerationStatus" style="margin-top: 10px; font-size: 13px; display: none;"></div>
              </div>
              
              <!-- QUESTIONS SECTION -->
              <div class="questions-section">
                <div class="section-header">Quiz Questions</div>
                <p>Add questions with multiple choice options. Don't forget to set the correct answer for each question.</p>
                <small id="questions_error" class="form-text"></small>
                
                <div id="questionsContainer">
                  <!-- Questions will be added here by JavaScript -->
                </div>
                
                <button type="button" class="btn-outline-primary" id="addQuestionBtn">
                  <i class="fas fa-plus"></i> Add New Question
                </button>
              </div>
              
              <!-- FORM BUTTONS -->
              <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <button type="button" class="btn-success" id="submitQuizBtn">
                  <i class="fas fa-save"></i> Save & Publish Quiz
                </button>
                <button type="button" class="btn-outline-primary" style="color: #666; border-color: #666;" id="cancelQuizBtn">
                  Cancel
                </button>
                <div style="margin-top:10px;">
                  <small id="form_message" class="form-text"></small>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- TAB 3: MY QUIZZES -->
      <div id="my-quizzes" class="tab-pane teacher-only">
        <div class="card">
          <div class="card-header">
            <h3 style="margin: 0;">My Created Quizzes</h3>
          </div>
          <div class="card-body">
            <div style="margin-bottom: 20px;">
              <input type="text" id="searchMyQuizzes" class="form-control" placeholder="Search your quizzes by title..." style="max-width: 400px;">
            </div>
            <div id="myQuizzesContainer">
              <!-- Quizzes will be dynamically added here -->
            </div>
          </div>
        </div>
      </div>
      

    </div>
  </div>

  <!-- PREVIEW MODAL -->
  <div class="preview-modal" id="previewModal">
    <div class="preview-content">
      <div class="preview-header">
        <h3 id="previewQuizTitle">Quiz Preview</h3>
        <button class="close-btn" id="closePreview">&times;</button>
      </div>
      <div class="preview-body" id="previewQuizBody">
        <!-- Preview content will be added here -->
      </div>
    </div>
  </div>

  <script>
    var myQuizzesData = [];
    var myQuizzesOriginalData = [];
    var browseQuizzesData = [];
    var browseQuizzesOriginalData = [];
    var currentMyPage = 1;
    var currentBrowsePage = 1;
    var itemsPerPage = 5;
    
    function displayMyQuizzesPage() {
      var startIndex = (currentMyPage - 1) * itemsPerPage;
      var endIndex = startIndex + itemsPerPage;
      var visibleQuizzes = myQuizzesData.slice(startIndex, endIndex);
      var tbody = document.getElementById('myQuizzesTableBody');
      tbody.innerHTML = '';
      
      visibleQuizzes.forEach(function(row) {
        var tr = document.createElement('tr');
        tr.innerHTML = row;
        tbody.appendChild(tr);
      });
      
      renderMyQuizzesPagination();
    }
    
    function renderMyQuizzesPagination() {
      var totalPages = Math.ceil(myQuizzesData.length / itemsPerPage);
      var paginationContainer = document.getElementById('myQuizzesPagination');
      if (!paginationContainer) return;
      
      var html = '';
      html += '<button onclick="previousMyPage()" ' + (currentMyPage === 1 ? 'disabled' : '') + '>Previous</button>';
      
      for (var i = 1; i <= totalPages; i++) {
        if (i === currentMyPage) {
          html += '<span class="active">' + i + '</span>';
        } else {
          html += '<button onclick="goToMyPage(' + i + ')">' + i + '</button>';
        }
      }
      
      html += '<button onclick="nextMyPage()" ' + (currentMyPage === totalPages || totalPages === 0 ? 'disabled' : '') + '>Next</button>';
      paginationContainer.innerHTML = html;
      
      var info = document.getElementById('myQuizzesPaginationInfo');
      if (info) {
        var start = myQuizzesData.length === 0 ? 0 : (currentMyPage - 1) * itemsPerPage + 1;
        var end = Math.min(currentMyPage * itemsPerPage, myQuizzesData.length);
        info.innerHTML = 'Showing ' + start + ' to ' + end + ' of ' + myQuizzesData.length + ' quizzes';
      }
    }
    
    function goToMyPage(page) {
      currentMyPage = page;
      displayMyQuizzesPage();
    }
    
    function nextMyPage() {
      var totalPages = Math.ceil(myQuizzesData.length / itemsPerPage);
      if (currentMyPage < totalPages) {
        currentMyPage++;
        displayMyQuizzesPage();
      }
    }
    
    function previousMyPage() {
      if (currentMyPage > 1) {
        currentMyPage--;
        displayMyQuizzesPage();
      }
    }
    
    function displayBrowseQuizzesPage() {
      var startIndex = (currentBrowsePage - 1) * itemsPerPage;
      var endIndex = startIndex + itemsPerPage;
      var visibleQuizzes = browseQuizzesData.slice(startIndex, endIndex);
      var tbody = document.getElementById('browseQuizzesTableBody');
      tbody.innerHTML = '';
      
      visibleQuizzes.forEach(function(row) {
        var tr = document.createElement('tr');
        tr.innerHTML = row;
        tbody.appendChild(tr);
      });
      
      renderBrowseQuizzesPagination();
    }
    
    function renderBrowseQuizzesPagination() {
      var totalPages = Math.ceil(browseQuizzesData.length / itemsPerPage);
      var paginationContainer = document.getElementById('browseQuizzesPagination');
      if (!paginationContainer) return;
      
      var html = '';
      html += '<button onclick="previousBrowsePage()" ' + (currentBrowsePage === 1 ? 'disabled' : '') + '>Previous</button>';
      
      for (var i = 1; i <= totalPages; i++) {
        if (i === currentBrowsePage) {
          html += '<span class="active">' + i + '</span>';
        } else {
          html += '<button onclick="goToBrowsePage(' + i + ')">' + i + '</button>';
        }
      }
      
      html += '<button onclick="nextBrowsePage()" ' + (currentBrowsePage === totalPages || totalPages === 0 ? 'disabled' : '') + '>Next</button>';
      paginationContainer.innerHTML = html;
      
      var info = document.getElementById('browseQuizzesPaginationInfo');
      if (info) {
        var start = browseQuizzesData.length === 0 ? 0 : (currentBrowsePage - 1) * itemsPerPage + 1;
        var end = Math.min(currentBrowsePage * itemsPerPage, browseQuizzesData.length);
        info.innerHTML = 'Showing ' + start + ' to ' + end + ' of ' + browseQuizzesData.length + ' quizzes';
      }
    }
    
    function goToBrowsePage(page) {
      currentBrowsePage = page;
      displayBrowseQuizzesPage();
    }
    
    function nextBrowsePage() {
      var totalPages = Math.ceil(browseQuizzesData.length / itemsPerPage);
      if (currentBrowsePage < totalPages) {
        currentBrowsePage++;
        displayBrowseQuizzesPage();
      }
    }
    
    function previousBrowsePage() {
      if (currentBrowsePage > 1) {
        currentBrowsePage--;
        displayBrowseQuizzesPage();
      }
    }
    
    // AI Question Generation (JSON used only for OpenAI API communication)
    function generateAIQuestions() {
      var title = document.getElementById('quizTitle').value.trim();
      var category = document.getElementById('quizCategory').value;
      var grade = document.getElementById('quizGrade').value;
      var description = document.getElementById('quizDescription').value.trim();
      var questionCount = document.getElementById('aiQuestionCount').value;
      
      if (!title) {
        alert('Please enter a quiz title before generating questions.');
        return;
      }
      if (!category) {
        alert('Please select a category before generating questions.');
        return;
      }
      if (!grade) {
        alert('Please select a grade level before generating questions.');
        return;
      }
      
      var statusDiv = document.getElementById('aiGenerationStatus');
      var generateBtn = document.getElementById('generateQuestionsBtn');
      
      statusDiv.style.display = 'block';
      statusDiv.style.color = '#4361ee';
      statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating questions... This may take a moment.';
      generateBtn.disabled = true;
      generateBtn.style.opacity = '0.6';
      
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '../controller/quizcontroller.php?action=generateQuestions', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      
      xhr.onload = function() {
        generateBtn.disabled = false;
        generateBtn.style.opacity = '1';
        
        if (xhr.status === 200) {
          var response = parseAIResponse(xhr.responseText);
          
          if (response && response.success && response.questions) {
            statusDiv.style.color = '#2ecc71';
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Successfully generated ' + response.questions.length + ' questions!';
            
            document.getElementById('questionsContainer').innerHTML = '';
            
            for (var i = 0; i < response.questions.length; i++) {
              var q = response.questions[i];
              addAIQuestion(q.text, q.options, q.correctAnswer);
            }
            
            setTimeout(function() {
              statusDiv.style.display = 'none';
            }, 5000);
          } else {
            statusDiv.style.color = '#e63946';
            statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + (response.error || 'Failed to generate questions.');
          }
        } else {
          statusDiv.style.color = '#e63946';
          statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Server error. Please try again.';
        }
      };
      
      xhr.onerror = function() {
        generateBtn.disabled = false;
        generateBtn.style.opacity = '1';
        statusDiv.style.color = '#e63946';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Network error. Please check your connection.';
      };
      
      var params = 'title=' + encodeURIComponent(title) +
                   '&category=' + encodeURIComponent(category) +
                   '&grade=' + encodeURIComponent(grade) +
                   '&description=' + encodeURIComponent(description) +
                   '&questionCount=' + encodeURIComponent(questionCount);
      
      xhr.send(params);
    }
    
    function parseAIResponse(text) {
      try {
        return JSON.parse(text);
      } catch (e) {
        return { success: false, error: 'Invalid response format' };
      }
    }
    
    function addAIQuestion(text, options, correctAnswer) {
      questionCount++;
      var questionHTML = '<div class="question-item" id="question-' + questionCount + '">' +
      '<div class="question-header">' +
      '<div class="section-subheader">Question ' + questionCount + '</div>' +
      '<button type="button" class="btn-danger btn-sm remove-question" style="float: right;"><i class="fas fa-trash"></i> Remove</button>' +
      '<div class="clearfix"></div>' +
      '</div>' +
      '<div class="form-group">' +
          '<label class="form-label"><strong>Question Text *</strong></label>' +
          '<input type="text" class="form-control question-text" name="questions[' + questionCount + '][text]" value="' + (text || '') + '" placeholder="Enter your question">' +
      '</div>' +
      '<div class="option-group">' +
          '<label class="form-label"><strong>Options *</strong></label>';
  
      var optionLetters = ['A', 'B', 'C', 'D'];
      for (var i = 0; i < optionLetters.length; i++) {
          var letter = optionLetters[i];
          var optionText = options && options[i] ? options[i] : '';
          var isCorrect = correctAnswer === i ? ' checked="checked"' : '';
          questionHTML += '<div class="option-row">' +
          '<div class="option-label">' + letter + '</div>' +
          '<input type="text" class="form-control option-input option-' + letter.toLowerCase() + '" name="questions[' + questionCount + '][options][' + i + '][text]" value="' + optionText + '" placeholder="Option ' + letter + '">' +
          '<div class="correct-option">' +
          '<button type="button" class="btn-outline-primary btn-sm set-correct" id="set-correct-Q' + questionCount + '-O' + letter + '">' +
          (isCorrect ? 'Correct' : 'Set Correct') +
          '</button>' +
          '<input type="hidden" class="correct-input" name="questions[' + questionCount + '][options][' + i + '][is_correct]" value="' + (isCorrect ? '1' : '0') + '">' +
          '</div>' +
          '<div class="clearfix"></div>' +
          '</div>';
      }
  
      questionHTML += '</div>' +
      '<div class="correct-answer-display">' +
          '<small class="text-muted">Correct answer: <span id="correct-answer-' + questionCount + '" style="' + (correctAnswer >= 0 ? 'color: green; font-weight: bold;' : '') + '">' +
          (correctAnswer >= 0 ? 'Option ' + optionLetters[correctAnswer] : 'Not set') +
          '</span></small>' +
      '</div>' +
      '</div>';
  
      var container = document.getElementById('questionsContainer');
      var newQuestion = document.createElement('div');
      newQuestion.innerHTML = questionHTML;
      container.appendChild(newQuestion);
      addQuestionEventListeners(questionCount);
      validateQuestions();
    }
    
    // Function to show initial validation errors
    function showInitialValidationErrors() {
      // Show error for quiz title
      var titleMsg = document.getElementById("quizTitle_error");
      if (titleMsg) {
        titleMsg.style.color = "red";
        titleMsg.innerHTML = "Quiz title must contain at least 3 characters";
      }
      
      // Show error for category
      var categoryMsg = document.getElementById("quizCategory_error");
      if (categoryMsg) {
        categoryMsg.style.color = "red";
        categoryMsg.innerHTML = "Please select a category";
      }
      
      // Show error for grade level
      var gradeMsg = document.getElementById("quizGrade_error");
      if (gradeMsg) {
        gradeMsg.style.color = "red";
        gradeMsg.innerHTML = "Please select a grade level";
      }
      
      // Show error for passing grade
      var passingMsg = document.getElementById("passingGrade_error");
      if (passingMsg) {
        passingMsg.style.color = "red";
        passingMsg.innerHTML = "Passing grade must be between 1 and 100";
      }
      
      // Show error for questions
      var questionsMsg = document.getElementById("questions_error");
      if (questionsMsg) {
        questionsMsg.style.color = "red";
        questionsMsg.innerHTML = "Please add at least one question";
      }
    }
    
    // Initialize when page loads
    window.onload = function() {
      // Fetch quizzes from server
      fetchAllQuizzes();
      displayMyQuizzes();
      // Fetch teacher statistics (e.g., Average Score)
      fetchTeacherStats();
      setupTabSwitching();
      setupRoleSwitching();
      setupSearchFunctionality();
      
      // Initialize form with one question
      addNewQuestion();
      
      // Show validation messages only in create mode (not edit mode)
      var quizIdField = document.getElementById('quizId');
      if (!quizIdField || !quizIdField.value) {
        showInitialValidationErrors();
      }
    };

    // Fetch teacher stats and update cards (Average Score)
    function fetchTeacherStats() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=getStats', true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              var temp = document.createElement('div');
              temp.innerHTML = xhr.responseText;
              var stats = temp.querySelectorAll('.stat');
              for (var i = 0; i < stats.length; i++) {
                var labelEl = stats[i].querySelector('.text-muted');
                var valueEl = stats[i].querySelector('.h4');
                if (!labelEl || !valueEl) continue;
                var label = labelEl.textContent || '';
                var value = (valueEl.textContent || '').trim();
                if (label.indexOf('Average Score') !== -1) {
                  var as = document.getElementById('averageScore');
                  if (as) as.textContent = value.match(/%$/) ? value : (value + '%');
                }
              }
            } catch (e) {
              console.warn('Failed to parse teacher stats:', e);
            }
          } else {
            console.warn('Could not fetch teacher stats. Status:', xhr.status);
          }
        }
      };
      xhr.send();
    }
    
    function fetchAllQuizzes() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=getAllQuizzes', true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          try {
            // Update stats with count from server response
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = xhr.responseText;
            var activeBadges = tempDiv.querySelectorAll('.badge.bg-success');
            document.getElementById('availableQuizzes').textContent = activeBadges.length;
            
            displayBrowseQuizzes(xhr.responseText);
          } catch (e) {
            console.error('Error fetching quizzes:', e);
          }
        }
      };
      xhr.send();
    }

    function setupTabSwitching() {
      // Tab switching
      var tabs = document.getElementById('mainTabs').getElementsByTagName('a');
      for (var i = 0; i < tabs.length; i++) {
        tabs[i].onclick = function(e) {
          e = e || window.event;
          if (e.preventDefault) {
            e.preventDefault();
          } else {
            e.returnValue = false;
          }
          
          // Remove active class from all tabs
          for (var j = 0; j < tabs.length; j++) {
            tabs[j].className = tabs[j].className.replace(' active', '');
          }
          
          // Hide all tab panes
          var panes = document.getElementsByClassName('tab-pane');
          for (var k = 0; k < panes.length; k++) {
            panes[k].className = panes[k].className.replace(' active', '');
          }
          
          // Add active class to clicked tab
          this.className += ' active';
          
          // Show corresponding tab pane
          var targetId = this.getAttribute('href').substring(1);
          document.getElementById(targetId).className += ' active';
          
          // Refresh quiz lists when switching to those tabs
          if (targetId === 'my-quizzes') {
            displayMyQuizzes();
          } else if (targetId === 'browse-quizzes') {
            fetchAllQuizzes();
          } else if (targetId === 'create-quiz') {
            // Check if form is in create mode (not edit mode)
            var quizIdField = document.getElementById('quizId');
            if (!quizIdField || !quizIdField.value) {
              // Only show validation messages in create mode
              showInitialValidationErrors();
            }
          }
        };
      }
    }
    
    function setupRoleSwitching() {
      // Role switching
      document.getElementById('userRole').onclick = function() {
        var currentRole = this.innerHTML;
        if (currentRole === 'Teacher') {
          this.innerHTML = 'Student';
          var teacherElements = document.getElementsByClassName('teacher-only');
          for (var i = 0; i < teacherElements.length; i++) {
            teacherElements[i].className += ' hidden';
          }
        } else {
          this.innerHTML = 'Teacher';
          var teacherElements = document.getElementsByClassName('teacher-only');
          for (var i = 0; i < teacherElements.length; i++) {
            teacherElements[i].className = teacherElements[i].className.replace(' hidden', '');
          }
        }
      };
    }
    
    // Setup search functionality
    function setupSearchFunctionality() {
      var searchBrowse = document.getElementById('searchBrowseQuizzes');
      var searchMy = document.getElementById('searchMyQuizzes');
      
      if (searchBrowse) {
        searchBrowse.addEventListener('keyup', function() {
          filterQuizzes('browseQuizzesContainer', this.value);
        });
      }
      
      if (searchMy) {
        searchMy.addEventListener('keyup', function() {
          filterQuizzes('myQuizzesContainer', this.value);
        });
      }
    }
    
    function filterQuizzes(containerId, searchTerm) {
      var searchLower = searchTerm.toLowerCase();
      
      if (containerId === 'myQuizzesContainer') {
        if (searchLower === '') {
          // Restore original data
          myQuizzesData = myQuizzesOriginalData.slice();
        } else {
          // Filter from original data
          myQuizzesData = [];
          myQuizzesOriginalData.forEach(function(rowHtml) {
            var tempTr = document.createElement('tr');
            tempTr.innerHTML = rowHtml;
            var firstCell = tempTr.querySelector('td');
            if (firstCell && firstCell.textContent.toLowerCase().includes(searchLower)) {
              myQuizzesData.push(rowHtml);
            }
          });
        }
        currentMyPage = 1;
        displayMyQuizzesPage();
        
      } else if (containerId === 'browseQuizzesContainer') {
        if (searchLower === '') {
          // Restore original data
          browseQuizzesData = browseQuizzesOriginalData.slice();
        } else {
          // Filter from original data
          browseQuizzesData = [];
          browseQuizzesOriginalData.forEach(function(rowHtml) {
            var tempTr = document.createElement('tr');
            tempTr.innerHTML = rowHtml;
            var firstCell = tempTr.querySelector('td');
            if (firstCell && firstCell.textContent.toLowerCase().includes(searchLower)) {
              browseQuizzesData.push(rowHtml);
            }
          });
        }
        currentBrowsePage = 1;
        displayBrowseQuizzesPage();
      }
    }
    
    function displayMyQuizzes() {
      var container = document.getElementById('myQuizzesContainer');
      
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=getMyQuizzes', true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          if (xhr.responseText.includes('No quizzes found')) {
            container.innerHTML = '<div class="empty-state" id="emptyMyQuizzes">' +
                '<i class="fas fa-file-alt"></i>' +
                '<h4>No quizzes created yet</h4>' +
                '<p>Create your first quiz to see it listed here</p>' +
                '<button class="btn-primary" onclick="switchToCreateTab()">Create Quiz</button>' +
              '</div>';
          } else {
            container.innerHTML = '<div class="card"><div class="card-body"><table class="table"><thead><tr><th>Title</th><th>Category</th><th>Questions</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody id="myQuizzesTableBody"></tbody></table></div>' +
              '<div class="pagination" id="myQuizzesPagination"></div>' +
              '<div class="pagination-info" id="myQuizzesPaginationInfo"></div></div>';
            
            var tempTbody = document.createElement('tbody');
            tempTbody.innerHTML = xhr.responseText;
            myQuizzesData = [];
            myQuizzesOriginalData = [];
            tempTbody.querySelectorAll('tr').forEach(function(row) {
              var rowHtml = row.innerHTML;
              myQuizzesData.push(rowHtml);
              myQuizzesOriginalData.push(rowHtml);
            });
            
            document.getElementById('myQuizzesCount').textContent = myQuizzesData.length;
            currentMyPage = 1;
            displayMyQuizzesPage();
          }
        }
      };
      xhr.send();
    }
    
    function displayBrowseQuizzes(htmlContent) {
      var container = document.getElementById('browseQuizzesContainer');
      
      if (htmlContent.includes('No quizzes found')) {
        container.innerHTML = '<div class="empty-state">' +
            '<i class="fas fa-search"></i>' +
            '<h4>No quizzes available</h4>' +
            '<p>Create a quiz to see it listed here</p>' +
          '</div>';
      } else {
        container.innerHTML = '<div class="card"><div class="card-body"><table class="table"><thead><tr><th>Title</th><th>Teacher</th><th>Category</th><th>Grade</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody id="browseQuizzesTableBody">' +
          '</tbody></table></div>' +
          '<div class="pagination" id="browseQuizzesPagination"></div>' +
          '<div class="pagination-info" id="browseQuizzesPaginationInfo"></div></div>';
        
        var tempTbody = document.createElement('tbody');
        tempTbody.innerHTML = htmlContent;
        browseQuizzesData = [];
        browseQuizzesOriginalData = [];
        tempTbody.querySelectorAll('tr').forEach(function(row) {
          var rowHtml = row.innerHTML;
          browseQuizzesData.push(rowHtml);
          browseQuizzesOriginalData.push(rowHtml);
        });
        
        currentBrowsePage = 1;
        displayBrowseQuizzesPage();
      }
    }
    
    function getCategoryName(category) {
      var categories = {
        'math': 'Mathematics',
        'science': 'Science',
        'english': 'English',
        'social-studies': 'Social Studies',
        'history': 'History',
        'geography': 'Geography',
        'biology': 'Biology',
        'chemistry': 'Chemistry',
        'physics': 'Physics',
        'earth-science': 'Earth Science',
        'environmental-science': 'Environmental Science',
        'astronomy': 'Astronomy',
        'art': 'Art',
        'music': 'Music',
        'other': 'Other'
      };
      
      return categories[category] || category;
    }
    
    function switchToCreateTab() {
      document.querySelector('a[href="#create-quiz"]').click();
    }
    
    function previewQuiz(quizId) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=preview&id=' + encodeURIComponent(quizId), true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            var body = document.getElementById('previewQuizBody');
            if (body) {
              body.innerHTML = xhr.responseText;
              var modal = document.getElementById('previewModal');
              if (modal) {
                modal.style.display = 'block';
              }
            }
          } else {
            alert('Error loading quiz preview. Status: ' + xhr.status);
            console.error('Preview error:', xhr.status, xhr.responseText);
          }
        }
      };
      xhr.send();
    }

    function editQuiz(quizId) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=getQuizFormData&id=' + encodeURIComponent(quizId), true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4 && xhr.status === 200) {
          var params = new URLSearchParams(xhr.responseText);
          
          // Set quiz ID FIRST before doing anything else
          document.getElementById('quizId').value = params.get('quiz_id') || '';
          
          document.getElementById('quizTitle').value = params.get('title') || '';
          document.getElementById('quizCategory').value = params.get('category') || '';
          document.getElementById('quizGrade').value = params.get('gradeLevel') || '';
          document.getElementById('quizDescription').value = params.get('description') || '';
          document.getElementById('passingGrade').value = params.get('passing_grade') || '';
          document.getElementById('timeLimit').value = params.get('time_limit') || '';
          
          // Set status radio button
          var status = params.get('status') || 'active';
          if (status === 'active') {
            document.getElementById('statusActive').checked = true;
          } else if (status === 'draft') {
            document.getElementById('statusDraft').checked = true;
          } else if (status === 'inactive') {
            document.getElementById('statusInactive').checked = true;
          }
          
          var qc = document.getElementById('questionsContainer');
          qc.innerHTML = '';
          questionCount = 0;
          var index = 0;
          while (params.has('questions['+index+'][text]')) {
            addNewQuestion();
            var qEl = document.getElementById('question-' + (index+1));
            var qTextInput = qEl.querySelector('.question-text');
            if (qTextInput) {
              qTextInput.value = params.get('questions['+index+'][text]') || '';
            }
            var opts = qEl.querySelectorAll('.option-input');
            for (var j=0; j<opts.length; j++) {
              var t = params.get('questions['+index+'][options]['+j+'][text]') || '';
              opts[j].value = t;
              var isCorrect = params.get('questions['+index+'][options]['+j+'][is_correct]') === '1';
              if (isCorrect) {
                var letters = ['A','B','C','D'];
                var letter = letters[j] || 'A';
                setCorrectAnswer((index+1).toString(), letter);
              }
            }
            index++;
          }
          
          // Add remove buttons to all questions in edit mode
          var allQuestions = document.querySelectorAll('.question-item');
          allQuestions.forEach(function(qEl, idx) {
            var questionId = idx + 1;
            var header = qEl.querySelector('.question-header');
            if (header && !qEl.querySelector('.remove-question')) {
              var removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'btn-danger btn-sm remove-question';
              removeBtn.id = 'remove-question-' + questionId;
              removeBtn.style.cssFloat = 'right';
              removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
              removeBtn.onclick = function() {
                removeQuestion(questionId);
              };
              header.appendChild(removeBtn);
            }
          });
          
          document.querySelector('a[href="#create-quiz"]').click();
          document.getElementById('quizForm').action = 'http://localhost/quizzes2/quizzes2/quiz/controller/quizcontroller.php?action=edit';
          
          // Clear validation error messages when editing
          var errorElements = document.querySelectorAll('[id$="_error"]');
          errorElements.forEach(function(el) { el.innerHTML = ''; });
        }
      };
      xhr.send();
    }
    
    function deleteMyQuiz(quizId) {
      if (confirm('Are you sure you want to delete this quiz?')) {
        requestDeleteQuiz(quizId);
      }
    }
    function deleteQuiz(quizId) {
      deleteMyQuiz(quizId);
    }
    
    function deleteQuizFromBrowse(quizId) {
      if (confirm('Are you sure you want to delete this quiz?')) {
        requestDeleteQuiz(quizId);
      }
    }
    
    function requestDeleteQuiz(quizId) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '../controller/quizcontroller.php?action=delete', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            alert('Quiz deleted successfully');
            // Reload the quizzes
            fetchAllQuizzes();
            displayMyQuizzes();
          } else {
            alert('Error deleting quiz: ' + xhr.responseText);
          }
        }
      };
      xhr.send('quiz_id=' + encodeURIComponent(quizId));
    }
    
    // Quiz Form Functionality
    var questionCount = 0;
    
    function addNewQuestion() {
      questionCount++;
      
      // Check if we're in edit mode
      var quizIdField = document.getElementById('quizId');
      var isEditMode = quizIdField && quizIdField.value;
      
      var questionHTML = '' +
      '<div class="question-item" id="question-' + questionCount + '">' +
      '<div class="question-header">' +
      '<div class="section-subheader">Question ' + questionCount + '</div>' +
      (questionCount > 1 ? '<button type="button" class="btn-danger btn-sm remove-question" id="remove-question-' + questionCount + '" style="float: right;"><i class="fas fa-trash"></i> Remove</button>' : '') +
      '<div class="clearfix"></div>' +
      '</div>' +
      '<div class="form-group">' +
          '<label class="form-label"><strong>Question Text *</strong></label>' +
          '<input type="text" class="form-control question-text" name="questions[' + questionCount + '][text]" placeholder="Enter your question">' +
          (isEditMode ? '' : '<small class="text-muted">Must be at least 1 character</small>') + 
      '</div>' +
      '<div class="option-group">' +
          '<label class="form-label"><strong>Options *</strong></label>';
  
      var optionLetters = ['A', 'B', 'C', 'D'];
      for (var i = 0; i < optionLetters.length; i++) {
          var letter = optionLetters[i];
          questionHTML += '' +
          '<div class="option-row">' +
          '<div class="option-label">' + letter + '</div>' +
          '<input type="text" class="form-control option-input option-' + letter.toLowerCase() + '" name="questions[' + questionCount + '][options][' + i + '][text]" placeholder="Option ' + letter + '">' +
          '<div class="correct-option">' +
          '<button type="button" class="btn-outline-primary btn-sm set-correct" id="set-correct-Q' + questionCount + '-O' + letter + '">' +
          'Set Correct' +
          '</button>' +
          '<input type="hidden" class="correct-input" name="questions[' + questionCount + '][options][' + i + '][is_correct]" value="0">' +
          '</div>' +
          '<div class="clearfix"></div>' +
          '</div>';
      }
  
      questionHTML += '' +
      '</div>' +
      '<div class="correct-answer-display">' +
          '<small class="text-muted">Correct answer: <span id="correct-answer-' + questionCount + '">Not set</span></small>' +
      '</div>' +
      '</div>';
  
      var container = document.getElementById('questionsContainer');
      var newQuestion = document.createElement('div');
      newQuestion.innerHTML = questionHTML;
      container.appendChild(newQuestion);
  
      // Add event listeners for the new question
      addQuestionEventListeners(questionCount);
      validateQuestions();
    }
    
    function addQuestionEventListeners(questionId) {
      var questionElement = document.getElementById('question-' + questionId);
      if (!questionElement) return;
  
      // Add event listeners to set-correct buttons
      var setCorrectButtons = questionElement.getElementsByClassName('set-correct');
      for (var j = 0; j < setCorrectButtons.length; j++) {
          setCorrectButtons[j].onclick = function() {
              var parts = this.id.split('-');
              var qPart = parts[2] || '';
              var oPart = parts[3] || '';
              var qid = qPart.replace(/^Q/, '');
              var opt = oPart.replace(/^O/, '');
              setCorrectAnswer(qid, opt);
          };
      }
  
      // Add event listener to remove button
      var removeBtn = questionElement.getElementsByClassName('remove-question')[0];
      if (removeBtn) {
          removeBtn.onclick = function() {
              var qid = this.id.replace('remove-question-', '');
              removeQuestion(qid);
          };
      }
    }
    
    function setCorrectAnswer(questionId, optionLetter) {
      var questionElement = document.getElementById('question-' + questionId);
      if (!questionElement) return;
  
      // Reset all options for this question
      var setCorrectButtons = questionElement.getElementsByClassName('set-correct');
      var correctInputs = questionElement.getElementsByClassName('correct-input');
  
      for (var i = 0; i < setCorrectButtons.length; i++) {
          var btn = setCorrectButtons[i];
          btn.innerHTML = 'Set Correct';
          btn.className = 'btn-outline-primary btn-sm set-correct';
  
          if (correctInputs[i]) {
              correctInputs[i].value = '0';
          }
      }
  
      // Set this option as correct
      var correctButton = document.getElementById('set-correct-Q' + questionId + '-O' + optionLetter);
      if (correctButton) {
          correctButton.innerHTML = 'Correct';
          correctButton.className = 'btn-success btn-sm set-correct';
  
          var correctHiddenInput = correctButton.nextElementSibling;
          if (correctHiddenInput && correctHiddenInput.type === 'hidden') {
              correctHiddenInput.value = '1';
          }
  
          // Update display
          var correctAnswerDisplay = document.getElementById('correct-answer-' + questionId);
          if (correctAnswerDisplay) {
              correctAnswerDisplay.innerHTML = 'Option ' + optionLetter;
              correctAnswerDisplay.style.color = 'green';
              correctAnswerDisplay.style.fontWeight = 'bold';
          }
      }
  
      validateQuestions();
    }
    
    function removeQuestion(questionId) {
      var questionElement = document.getElementById('question-' + questionId);
      if (questionElement && questionElement.parentNode) {
          questionElement.parentNode.removeChild(questionElement);
          renumberQuestions();
          validateQuestions();
      }
    }
    
    function renumberQuestions() {
      var questions = document.getElementsByClassName('question-item');
      questionCount = questions.length;
  
      for (var i = 0; i < questions.length; i++) {
          var questionId = i + 1;
          questions[i].id = 'question-' + questionId;
  
          var header = questions[i].getElementsByClassName('section-subheader')[0];
          if (header) {
              header.innerHTML = 'Question ' + questionId;
          }
  
          // Update all form field names with new question number
          var questionText = questions[i].getElementsByClassName('question-text')[0];
          if (questionText) {
              questionText.name = 'questions[' + questionId + '][text]';
          }
  
          var optionLetters = ['A','B','C','D'];
          var optionInputs = questions[i].getElementsByClassName('option-input');
          var correctInputs = questions[i].getElementsByClassName('correct-input');
          
          for (var j = 0; j < optionInputs.length; j++) {
              optionInputs[j].name = 'questions[' + questionId + '][options][' + j + '][text]';
              correctInputs[j].name = 'questions[' + questionId + '][options][' + j + '][is_correct]';
          }
  
          // Update button IDs
          for (var ol = 0; ol < optionLetters.length; ol++) {
              var letter = optionLetters[ol];
              var inputs = questions[i].getElementsByClassName('option-' + letter.toLowerCase());
              if (inputs.length > 0) {
                  var optionRow = inputs[0].parentNode;
                  var btns = optionRow.getElementsByClassName('set-correct');
                  if (btns.length > 0) {
                      btns[0].id = 'set-correct-Q' + questionId + '-O' + letter;
                  }
              }
          }
  
          var removeButtons = questions[i].getElementsByClassName('remove-question');
          for (var k = 0; k < removeButtons.length; k++) {
              var removeBtn = removeButtons[k];
              removeBtn.id = 'remove-question-' + questionId;
          }
  
          // Update correct answer display ID
          var correctDisplay = questions[i].getElementsByClassName('correct-answer-display')[0];
          if (correctDisplay) {
              var span = correctDisplay.getElementsByTagName('span')[0];
              if (span) {
                  span.id = 'correct-answer-' + questionId;
              }
          }
      }
    }
    
    // Validation flags
    var quizTitle = false;
    var quizCategory = false;
    var quizGrade = false;
    var passingGrade = false;
    var questionsValid = false;
    
    // Real-time verification of quiz title
    document.getElementById("quizTitle").onkeyup = function () {
        var value = this.value.replace(/^\s+|\s+\$/g, '');
        var msg = document.getElementById("quizTitle_error");
        
        // Check if in edit mode
        var quizIdField = document.getElementById('quizId');
        var isEditMode = quizIdField && quizIdField.value;
  
        if (value.length >= 3) {
            if (!isEditMode) {
                msg.style.color = "green";
                msg.innerHTML = "Valid";
            }
            quizTitle = true;
        } else {
            if (!isEditMode) {
                msg.style.color = "red";
                msg.innerHTML = "Quiz title must contain at least 3 characters";
            }
            quizTitle = false;
        }
    };
    
    // Verification of category on change
    document.getElementById("quizCategory").onchange = function () {
        var value = this.value;
        var msg = document.getElementById("quizCategory_error");
        
        // Check if in edit mode
        var quizIdField = document.getElementById('quizId');
        var isEditMode = quizIdField && quizIdField.value;
  
        if (value !== "") {
            if (!isEditMode) {
                msg.style.color = "green";
                msg.innerHTML = "Valid";
            }
            quizCategory = true;
        } else {
            if (!isEditMode) {
                msg.style.color = "red";
                msg.innerHTML = "Please select a category";
            }
            quizCategory = false;
        }
    };
    
    // Verification of grade level on change
    document.getElementById("quizGrade").onchange = function () {
        var value = this.value;
        var msg = document.getElementById("quizGrade_error");
        
        // Check if in edit mode
        var quizIdField = document.getElementById('quizId');
        var isEditMode = quizIdField && quizIdField.value;
  
        if (value !== "") {
            if (!isEditMode) {
                msg.style.color = "green";
                msg.innerHTML = "Valid";
            }
            quizGrade = true;
        } else {
            if (!isEditMode) {
                msg.style.color = "red";
                msg.innerHTML = "Please select a grade level";
            }
            quizGrade = false;
        }
    };
    
    // Real-time verification of passing grade
    document.getElementById("passingGrade").onkeyup = function () {
        var value = parseInt(this.value, 10);
        var msg = document.getElementById("passingGrade_error");
        
        // Check if in edit mode
        var quizIdField = document.getElementById('quizId');
        var isEditMode = quizIdField && quizIdField.value;
  
        if (!isNaN(value) && value >= 1 && value <= 100) {
            if (!isEditMode) {
                msg.style.color = "green";
                msg.innerHTML = "Valid";
            }
            passingGrade = true;
        } else {
            if (!isEditMode) {
                msg.style.color = "red";
                msg.innerHTML = "Passing grade must be between 1 and 100";
            }
            passingGrade = false;
        }
    };
    
    // Voice to text for Description field
    var recognition = null;
    var isListening = false;
    
    function startVoiceRecognition() {
        var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
            return;
        }
        
        if (isListening) {
            stopVoiceRecognition();
            return;
        }
        
        if (!recognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                isListening = true;
                document.getElementById('voiceBtn').style.background = '#f44336';
                document.getElementById('voiceBtn').innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="white" style="margin-left: 2px;"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
                document.getElementById('voiceStatus').style.display = 'block';
                document.getElementById('voiceStatus').style.color = '#4CAF50';
                document.getElementById('voiceStatus').innerHTML = 'Listening... Click again to stop';
            };
            
            recognition.onresult = function(event) {
                var transcript = '';
                for (var i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript + ' ';
                    }
                }
                if (transcript) {
                    var currentText = document.getElementById('quizDescription').value;
                    document.getElementById('quizDescription').value = currentText + transcript;
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    document.getElementById('voiceStatus').style.color = '#ff9800';
                    document.getElementById('voiceStatus').innerHTML = 'No speech detected. Try again.';
                } else {
                    document.getElementById('voiceStatus').style.color = '#f44336';
                    document.getElementById('voiceStatus').innerHTML = 'Error: ' + event.error;
                }
                stopVoiceRecognition();
            };
            
            recognition.onend = function() {
                if (isListening) {
                    stopVoiceRecognition();
                }
            };
        }
        
        recognition.start();
    }
    
    function stopVoiceRecognition() {
        if (recognition) {
            recognition.stop();
        }
        isListening = false;
        document.getElementById('voiceBtn').style.background = '#4CAF50';
        document.getElementById('voiceBtn').innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="white" style="margin-left: 3px;"><polygon points="5,3 5,21 21,12"></polygon></svg>';
        document.getElementById('voiceStatus').style.display = 'none';
    }
    
    // Question validation function
    function validateQuestions() {
        var questions = document.getElementsByClassName('question-item');
        var msg = document.getElementById("questions_error");
        
        // Check if in edit mode
        var quizIdField = document.getElementById('quizId');
        var isEditMode = quizIdField && quizIdField.value;
  
        if (questions.length === 0) {
            if (!isEditMode) {
                msg.style.color = "red";
                msg.innerHTML = "Please add at least one question";
            }
            questionsValid = false;
            return;
        }
  
        var allQuestionsHaveCorrectAnswer = true;
        var allQuestionsHaveText = true;
        var allOptionsFilled = true;
  
        for (var i = 0; i < questions.length; i++) {
            var question = questions[i];
            var questionText = question.getElementsByClassName('question-text')[0].value.replace(/^\s+|\s+\$/g, '');
            var hasCorrectAnswer = false;
  
            // Check for correct answer
            var correctInputs = question.getElementsByClassName('correct-input');
            for (var j = 0; j < correctInputs.length; j++) {
                if (correctInputs[j].value === '1') {
                    hasCorrectAnswer = true;
                    break;
                }
            }
  
            // Check question text
            if (questionText.length < 1) {
                allQuestionsHaveText = false;
                question.getElementsByClassName('question-text')[0].style.border = "1px solid red";
            } else {
                question.getElementsByClassName('question-text')[0].style.border = "1px solid #ddd";
            }
  
            // Check correct answer
            if (!hasCorrectAnswer) {
                allQuestionsHaveCorrectAnswer = false;
                question.style.border = "2px solid red";
            } else {
                question.style.border = "1px solid #e0e0e0";
            }
  
            // Check options
            var optionsFilled = true;
            var optionInputs = question.getElementsByClassName('option-input');
            for (var k = 0; k < optionInputs.length; k++) {
                var optionValue = optionInputs[k].value.replace(/^\s+|\s+$/g, '');
                if (optionValue === "") {
                    optionsFilled = false;
                    optionInputs[k].style.border = "1px solid red";
                } else {
                    optionInputs[k].style.border = "1px solid #ddd";
                }
            }
  
            if (!optionsFilled) allOptionsFilled = false;
        }
  
        if (!allQuestionsHaveText) {
            if (!isEditMode) {
                msg.style.color = "red";
                msg.innerHTML = "All questions must have text (min. 1 character)";
            }
            questionsValid = false;
        } else if (!allQuestionsHaveCorrectAnswer) {
            if (!isEditMode) {
                msg.style.color = "red";
                msg.innerHTML = "Please set correct answer for all questions";
            }
            questionsValid = false;
        } else if (!allOptionsFilled) {
            if (!isEditMode) {
                msg.style.color = "red";
                msg.innerHTML = "Please fill all options for each question";
            }
            questionsValid = false;
        } else {
            if (!isEditMode) {
                msg.style.color = "green";
                msg.innerHTML = "Valid (" + questions.length + " questions)";
            }
            questionsValid = true;
        }
    }
    
    // Submit quiz form via traditional form submission
    function submitQuizForm() {
        var isEdit = !!document.getElementById('quizId').value;
        
        // Only validate when creating new quiz, not when editing
        if (!isEdit) {
            validateQuestions();
            if (!(quizTitle && quizCategory && quizGrade && passingGrade && questionsValid)) {
                var formMessage = document.getElementById('form_message');
                if (formMessage) { formMessage.style.color = 'red'; formMessage.innerHTML = 'Please fix all validation errors before submitting!'; }
                else { alert('Please fix all validation errors before submitting!'); }
                return;
            }
        }
        var actionUrl = isEdit
          ? '../controller/quizcontroller.php?action=edit'
          : '../controller/quizcontroller.php?action=create';

        var params = new URLSearchParams();
        params.set('ajax', '1');
        params.set('quiz_id', document.getElementById('quizId').value || '');
        params.set('title', document.getElementById('quizTitle').value);
        params.set('category', document.getElementById('quizCategory').value);
        params.set('gradeLevel', document.getElementById('quizGrade').value);
        params.set('description', document.getElementById('quizDescription').value || '');
        
        // Get selected status from radio buttons
        var statusRadio = document.querySelector('input[name="status"]:checked');
        params.set('status', statusRadio ? statusRadio.value : 'active');
        
        params.set('passing_grade', document.getElementById('passingGrade').value || '70');
        params.set('time_limit', document.getElementById('timeLimit').value || '0');

        var questions = document.getElementsByClassName('question-item');
        for (var i = 0; i < questions.length; i++) {
            var qEl = questions[i];
            var qText = qEl.querySelector('.question-text').value;
            params.set('questions[' + i + '][text]', qText);
            var optionInputs = qEl.querySelectorAll('.option-input');
            var correctInputs = qEl.querySelectorAll('.correct-input');
            for (var j = 0; j < optionInputs.length; j++) {
                params.set('questions[' + i + '][options][' + j + '][text]', optionInputs[j].value);
                var isC = (correctInputs[j] && correctInputs[j].value === '1') ? '1' : '0';
                params.set('questions[' + i + '][options][' + j + '][is_correct]', isC);
            }
        }

        var xhr = new XMLHttpRequest();
        xhr.open('POST', actionUrl, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onreadystatechange = function(){
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              var text = xhr.responseText || '';
              var qid = '';
              if (text.indexOf('quiz_id=') === 0) { qid = text.split('=')[1]; }
              // Message removed - no alert on successful save
              
              // Reset form after successful save
              document.getElementById('quizForm').reset();
              document.getElementById('quizId').value = '';
              document.getElementById('questionsContainer').innerHTML = '';
              questionCount = 0;
              addNewQuestion();
              
              // Reset form action to create
              document.getElementById('quizForm').action = '../controller/quizcontroller.php?action=create';
              
              // Reset validation flags
              quizTitle = false;
              quizCategory = false;
              quizGrade = false;
              passingGrade = false;
              questionsValid = false;
              
              // Show validation messages for next quiz
              showInitialValidationErrors();
              
              fetchAllQuizzes();
              displayMyQuizzes();
              
          // Switch to My Quizzes tab to see the result
              document.querySelector('a[href="#my-quizzes"]').click();
            }
            // Error message removed - no alert on error
          }
        };
        xhr.send(params.toString());
    }
    
    // Initialize form buttons
    document.getElementById('addQuestionBtn').onclick = addNewQuestion;
    document.getElementById('submitQuizBtn').onclick = submitQuizForm;
    document.getElementById('quizForm').addEventListener('submit', function(e){ e.preventDefault(); submitQuizForm(); });
    document.getElementById('cancelQuizBtn').onclick = function() {
        if (confirm('Are you sure you want to cancel? All unsaved changes will be lost.')) {
            window.location.reload();
        }
    };
    
    // Preview modal functionality
    document.getElementById('closePreview').onclick = function() {
      document.getElementById('previewModal').style.display = 'none';
    };
    
    window.onclick = function(e) {
      if (e.target == document.getElementById('previewModal')) {
        document.getElementById('previewModal').style.display = 'none';
      }
    };

    window.editQuiz = editQuiz;
    window.previewQuiz = previewQuiz;
    window.deleteQuiz = deleteQuiz;
    window.deleteMyQuiz = deleteMyQuiz;
    
    (function(){
      var form = document.getElementById('aiGenForm');
      if (form) {
        form.addEventListener('submit', function(e){
          e.preventDefault ? e.preventDefault() : (e.returnValue = false);
          startAiGeneration();
        });
      }
      var insertBtn = document.getElementById('aiInsertBtn');
      if (insertBtn) {
        insertBtn.onclick = insertIntoCreateQuiz;
      }
      var printBtn = document.getElementById('aiPrintBtn');
      if (printBtn) {
        printBtn.onclick = function(){ window.print(); };
      }
      var editBtn = document.getElementById('aiEditBtn');
      if (editBtn) {
        editBtn.onclick = function(){
          if (typeof window.enableEditMode === 'function') { window.enableEditMode(); }
          else {
            var cards = document.querySelectorAll('.question-card');
            for (var i = 0; i < cards.length; i++) {
              cards[i].contentEditable = true;
              cards[i].style.border = '2px dashed #007bff';
            }
          }
        };
      }
      var saveBtn = document.getElementById('aiSaveBtn');
      if (saveBtn) {
        saveBtn.onclick = function(){
          if (typeof window.saveQuizToDatabase === 'function') { window.saveQuizToDatabase(); }
          else { alert('Save function not loaded.'); }
        };
      }
      var refreshBtn = document.getElementById('aiRefreshStatusBtn');
      if (refreshBtn) {
        refreshBtn.onclick = function(){ checkAiStatus(); };
      }
      // Initial AI status check
      checkAiStatus();
    })();
    
    function startAiGeneration() {
      var subject = document.getElementById('aiSubject').value || '';
      var topic = document.getElementById('aiTopic').value || '';
      var difficulty = document.getElementById('aiDifficulty').value || 'medium';
      var numQ = document.getElementById('aiNumQuestions').value || '5';
      var loading = document.getElementById('aiLoading');
      var results = document.getElementById('aiQuizResults');
      var container = document.getElementById('aiQuizContainer');
      loading.style.display = 'block';
      results.style.display = 'none';
      container.innerHTML = '';
      
      var params = 'title=' + encodeURIComponent(topic + ' Quiz') +
                   '&category=' + encodeURIComponent(subject.toLowerCase()) +
                   '&grade=8' +
                   '&description=' + encodeURIComponent('Auto-generated quiz on ' + topic + ' (' + subject + ', ' + difficulty + ').') +
                   '&questionCount=' + encodeURIComponent(numQ);
      
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '../controller/quizcontroller.php?action=generateQuestions', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4) {
          loading.style.display = 'none';
          if (xhr.status === 200) {
            try {
              var resp = JSON.parse(xhr.responseText);
              if (resp.success && resp.questions && resp.questions.length) {
                for (var i=0; i<resp.questions.length; i++) {
                  var q = resp.questions[i];
                  var card = document.createElement('div');
                  card.className = 'question-card';
                  var html = '<div><strong>Q' + (i+1) + ':</strong> ' + escapeHtml(q.text || '') + '</div>';
                  html += '<ul style="margin-top:8px;">';
                  for (var j=0; j<q.options.length; j++) {
                    html += '<li>' + escapeHtml(q.options[j] || '') + (q.correctAnswer === j ? ' <span class="correct-answer">(correct)</span>' : '') + '</li>';
                  }
                  html += '</ul>';
                  card.innerHTML = html;
                  container.appendChild(card);
                }
                results.style.display = 'block';
              } else {
                container.innerHTML = '<div class="error">Failed to generate questions: ' + escapeHtml(resp.error || 'Unknown error') + '</div>';
                results.style.display = 'block';
              }
            } catch(ex) {
              container.innerHTML = '<div class="error">Invalid response format.</div>';
              results.style.display = 'block';
            }
          } else {
            container.innerHTML = '<div class="error">Server error (' + xhr.status + ').</div>';
            results.style.display = 'block';
          }
        }
      };
      xhr.send(params);
    }
    
    function insertIntoCreateQuiz() {
      var results = document.getElementById('aiQuizContainer');
      if (!results) return;
      var cards = results.getElementsByClassName('question-card');
      if (!cards || cards.length === 0) return;
      
      for (var i=0; i<cards.length; i++) {
        var textEl = cards[i].getElementsByTagName('div')[0];
        var qText = '';
        if (textEl) {
          qText = textEl.textContent.replace(/^Q\d+:\s*/, '');
        }
        var opts = [];
        var lis = cards[i].getElementsByTagName('li');
        for (var j=0; j<lis.length; j++) {
          var t = lis[j].textContent.replace(/\s*\(correct\)\s*$/, '');
          opts.push(t);
        }
        addNewQuestion();
        var qEl = document.getElementById('question-' + questionCount);
        var qInput = qEl ? qEl.querySelector('.question-text') : null;
        if (qInput) { qInput.value = qText; }
        var optionInputs = qEl ? qEl.querySelectorAll('.option-input') : [];
        for (var k=0; k<optionInputs.length && k<opts.length; k++) {
          optionInputs[k].value = opts[k];
        }
      }
      var tab = document.querySelector('a[href="#create-quiz"]');
      if (tab) { tab.click(); }
    }
    
    function escapeHtml(str) {
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(str || ''));
      return div.innerHTML;
    }

    function checkAiStatus() {
      var badge = document.getElementById('aiStatusBadge');
      var details = document.getElementById('aiStatusDetails');
      if (!badge || !details) return;
      details.textContent = 'Checking';
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=aiStatus', true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4) {
          try {
            var data = JSON.parse(xhr.responseText);
            var provider = (data.provider || '').toLowerCase();
            if (data.ok && data.hasKey && data.api === 'reachable') {
              badge.className = 'badge bg-success';
              badge.textContent = 'AI Ready';
              details.textContent = 'Provider: ' + (provider || 'unknown');
              details.style.color = '#2ecc71';
            } else {
              badge.className = 'badge bg-secondary';
              badge.textContent = 'AI Unavailable';
              var msg = data.error ? data.error : 'Configure API key';
              details.textContent = msg;
              details.style.color = '#e63946';
            }
          } catch (e) {
            badge.className = 'badge bg-secondary';
            badge.textContent = 'AI Unavailable';
            details.textContent = 'Status parse error';
            details.style.color = '#e63946';
          }
        }
      };
      xhr.send();
    }

    // Delegated handler for Remove buttons on AI-generated questions in Create Quiz form
    document.addEventListener('click', function(e) {
      var btn = e.target.closest('.remove-question');
      if (!btn) return;
      e.preventDefault();
      var questionItem = btn.closest('.question-item');
      if (questionItem && questionItem.parentNode) {
        questionItem.parentNode.removeChild(questionItem);
      }
    });
  </script>
  <script src="../quiz-generator.js"></script>
</body>
</html>
