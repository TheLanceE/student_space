<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>EduMind+ | Quizzes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f7fb; margin: 0; padding: 0; }
    .navbar { background-color: #4361ee; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar-brand { color: white; font-weight: bold; font-size: 24px; text-decoration: none; margin-left: 20px; }
    .nav-links { display: block; list-style: none; margin: 0; padding: 0; margin-left: 30px; float: left; }
    .nav-links li { float: left; margin-right: 20px; }
    .nav-links a { color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; display: block; }
    .nav-links a.active { background-color: rgba(255,255,255,0.2); }
    .user-role { background: rgba(255,255,255,0.2); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-left: 10px; cursor: pointer; float: left; }
    .container { width: 1200px; margin: 0 auto; padding: 20px; }
    .welcome-section { background: #4361ee; color: white; border-radius: 10px; padding: 30px; margin-bottom: 30px; }
    .card { background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; padding: 20px; border: 1px solid #e0e0e0; }
    .stats-card { text-align: center; padding: 20px 15px; }
    .stats-card i { font-size: 32px; margin-bottom: 15px; color: #4361ee; }
    .stats-card .number { font-size: 32px; font-weight: bold; margin: 10px 0; }
    .quiz-card { position: relative; height: auto; margin-bottom: 20px; }
    .quiz-badge { position: absolute; top: 15px; right: 15px; background: #4361ee; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 12px; }
    .btn-primary { background: #4361ee; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-success { background: #4cc9f0; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-outline-primary { background: transparent; color: #4361ee; border: 1px solid #4361ee; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
    .btn-danger { background: #e63946; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    
    /* Form Styles */
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
    .form-select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
    .hidden { display: none; }
    
    /* Tabs */
    .nav-tabs { border-bottom: 2px solid #e0e0e0; display: block; list-style: none; padding: 0; margin: 0; }
    .nav-tabs li { float: left; margin-right: 10px; }
    .nav-tabs a { padding: 12px 25px; text-decoration: none; color: #666; font-weight: bold; border-bottom: 3px solid transparent; display: block; }
    .nav-tabs a.active { color: #4361ee; border-bottom: 3px solid #4361ee; }
    .tab-content { padding: 20px 0; clear: both; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    
    /* Question Styles */
    .questions-section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0; }
    .question-item { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #e0e0e0; }
    .question-header { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0; overflow: hidden; }
    .option-group { margin-top: 15px; }
    .option-row { margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #e0e0e0; overflow: hidden; }
    .option-label { width: 30px; font-weight: bold; color: #4361ee; float: left; margin-right: 10px; }
    .option-input { width: 65%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; float: left; }
    .correct-option { width: 30%; text-align: center; float: right; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .correct-answer-display { padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #4cc9f0; margin-top: 10px; }
    .form-text { font-size: 12px; margin-top: 4px; }
    
    /* Additional styles */
    .error-message { color: #e63946; font-size: 12px; margin-top: 5px; }
    .success-message { color: #2ecc71; font-size: 14px; margin-top: 10px; }
    .teacher-badge { background: #4cc9f0; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px; }
    
    /* Clearfix */
    .clearfix:after { content: ""; display: table; clear: both; }
    .clearfix { zoom: 1; } /* For IE6/7 */
    
    /* Row and column system */
    .row { overflow: hidden; margin: 0 -10px; }
    .col-md-3, .col-md-4, .col-md-6, .col-md-8 { float: left; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; padding: 0 10px; }
    .col-md-3 { width: 25%; }
    .col-md-4 { width: 33.333%; }
    .col-md-6 { width: 50%; }
    .col-md-8 { width: 66.666%; }
    .text-end { text-align: right; }
    
    /* Section headers */
    .section-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
    .section-subheader { font-size: 16px; font-weight: bold; margin: 15px 0 10px 0; color: #555; }
    
    /* Table styles */
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    
    /* Quiz list */
    .quiz-list { overflow: hidden; }
    .empty-state { text-align: center; padding: 40px; color: #666; }
    .empty-state i { font-size: 48px; margin-bottom: 15px; color: #ddd; }
    
    /* Preview Modal Styles */
    .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .preview-content { position: absolute; top: 50%; left: 50%; margin-left: -400px; margin-top: -45vh; background: white; border-radius: 10px; width: 800px; max-height: 90vh; overflow-y: auto; }
    .preview-header { padding: 20px; border-bottom: 1px solid #e0e0e0; overflow: hidden; }
    .preview-body { padding: 20px; }
    .preview-question { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
    .preview-options { margin-top: 10px; }
    .preview-option { padding: 10px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #e0e0e0; }
    .preview-option.correct { background: #e8f5e8; border-color: #2ecc71; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; float: right; }
    
    /* Badge styles */
    .badge { display: inline-block; padding: 3px 8px; font-size: 12px; font-weight: bold; border-radius: 4px; }
    .bg-success { background: #2ecc71; color: white; }
    .bg-secondary { background: #95a5a6; color: white; }
    .bg-primary { background: #4361ee; color: white; }
  </style>
</head>
<body>
  <!-- NAVIGATION BAR -->
  <div class="navbar">
    <div class="container">
      <div class="clearfix">
        <a href="#" class="navbar-brand">
          <i class="fas fa-graduation-cap"></i> EduMind
        </a>
        <ul class="nav-links">
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="#" class="active">Quizzes</a></li>
          <li><a href="profile.html">Profile</a></li>
        </ul>
        <div style="float: right;">
          <span class="user-role" id="userRole">Teacher</span>
          <button class="btn-outline-primary" style="color: white; border-color: white; margin-left: 10px;">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="container">
    <!-- WELCOME SECTION -->
    <div class="welcome-section">
      <div class="row">
        <div class="col-md-8">
          <h1 style="margin: 0 0 10px 0;">Welcome to EduMind Quizzes</h1>
          <p style="margin: 0; font-size: 16px;">Create and manage quizzes for your students.</p>
        </div>
        <div class="col-md-4 text-end">
          <div style="background: white; color: #4361ee; border-radius: 50%; width: 80px; height: 80px; display: inline-block; text-align: center; line-height: 80px;">
            <i class="fas fa-brain" style="font-size: 32px;"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- STATS CARDS -->
    <div class="row" style="margin-bottom: 20px;">
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-list-alt"></i>
          <div class="number" id="availableQuizzes">2</div>
          <div>Available Quizzes</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-check-circle"></i>
          <div class="number" id="completedQuizzes">7</div>
          <div>Quizzes Completed</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-trophy"></i>
          <div class="number" id="averageScore">85%</div>
          <div>Average Score</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-plus-circle"></i>
          <div class="number" id="myQuizzesCount">0</div>
          <div>My Created Quizzes</div>
        </div>
      </div>
    </div>

    <!-- TABS SECTION -->
    <ul class="nav-tabs" id="mainTabs">
      <li class="teacher-only"><a href="#browse-quizzes" class="active">Browse Quizzes</a></li>
      <li class="teacher-only"><a href="#create-quiz">Create Quiz</a></li>
      <li class="teacher-only"><a href="#my-quizzes">My Quizzes</a></li>
    </ul>
    
    <div class="tab-content">
      <!-- TAB 1: BROWSE QUIZZES -->
      <div id="browse-quizzes" class="tab-pane active teacher-only">
        <h2 style="margin-bottom: 20px;">Available Quizzes</h2>
        <div class="quiz-list" id="browseQuizzesContainer">
          <!-- Quizzes will be dynamically added here -->
        </div>
      </div>
      
      <!-- TAB 2: CREATE QUIZ -->
      <div id="create-quiz" class="tab-pane teacher-only">
        <div class="card">
          <div class="card-header">
            <h3 style="margin: 0;">Create New Quiz</h3>
          </div>
          <div class="card-body">
            <form id="quizForm" name="quizForm" onsubmit="return false;">
              <!-- QUIZ BASIC INFORMATION -->
              <div class="section-header">Quiz Information</div>
              
              <!-- Quiz Title -->
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Quiz Title *</label>
                    <input type="text" class="form-control" id="quizTitle" name="title" placeholder="Enter quiz title">
                    <small id="quizTitle_error" class="form-text"></small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select class="form-select" id="quizCategory" name="category">
                      <option value="">Select category</option>
                      <optgroup label="Core Subjects">
                        <option value="math">Mathematics</option>
                        <option value="science">Science</option>
                        <option value="english">English Language Arts</option>
                        <option value="social-studies">Social Studies</option>
                        <option value="history">History</option>
                        <option value="geography">Geography</option>
                      </optgroup>
                      <optgroup label="Science Specializations">
                        <option value="biology">Biology</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="physics">Physics</option>
                        <option value="earth-science">Earth Science</option>
                        <option value="environmental-science">Environmental Science</option>
                        <option value="astronomy">Astronomy</option>
                      </optgroup>
                      <optgroup label="Other">
                        <option value="art">Art</option>
                        <option value="music">Music</option>
                        <option value="other">Other</option>
                      </optgroup>
                    </select>
                    <small id="quizCategory_error" class="form-text"></small>
                  </div>
                </div>
              </div>
              
              <!-- Grade Level and Time Limit -->
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Grade Level *</label>
                    <select class="form-select" id="quizGrade" name="grade">
                      <option value="">Select grade</option>
                      <optgroup label="Elementary School">
                        <option value="1">Grade 1</option>
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                      </optgroup>
                      <optgroup label="Middle School">
                        <option value="6">Grade 6</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                      </optgroup>
                      <optgroup label="High School">
                        <option value="9">Grade 9 (Freshman)</option>
                        <option value="10">Grade 10 (Sophomore)</option>
                        <option value="11">Grade 11 (Junior)</option>
                        <option value="12">Grade 12 (Senior)</option>
                      </optgroup>
                    </select>
                    <small id="quizGrade_error" class="form-text"></small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Time Limit (minutes)</label>
                    <input type="text" class="form-control" id="timeLimit" name="time_limit" placeholder="e.g., 30">
                  </div>
                </div>
              </div>

              <!-- Passing Grade and Status -->
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Passing Grade (%) *</label>
                    <input type="text" class="form-control" id="passingGrade" name="passing_grade" placeholder="e.g., 70">
                    <small id="passingGrade_error" class="form-text"></small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label">Quiz Status *</label>
                    <div style="margin-top: 8px;">
                      <input type="radio" name="status" id="statusActive" value="active" checked="checked">
                      <label for="statusActive">Active</label>
                      <input type="radio" name="status" id="statusDraft" value="draft" style="margin-left: 15px;">
                      <label for="statusDraft">Draft</label>
                      <input type="radio" name="status" id="statusInactive" value="inactive" style="margin-left: 15px;">
                      <label for="statusInactive">Inactive</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Description -->
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="quizDescription" name="description" rows="3" placeholder="Enter quiz description (optional)"></textarea>
              </div>

              <!-- QUESTIONS SECTION -->
              <div class="questions-section">
                <div class="section-header">Quiz Questions</div>
                <p>Add questions with multiple choice options. Don't forget to set the correct answer for each question.</p>
                <small id="questions_error" class="form-text"></small>
                
                <div id="questionsContainer">
                  <!-- Questions will be added here by JavaScript -->
                </div>
                
                <button type="button" class="btn-outline-primary" id="addQuestionBtn">
                  <i class="fas fa-plus"></i> Add New Question
                </button>
              </div>
              
              <!-- FORM BUTTONS -->
              <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <button type="button" class="btn-success" id="submitQuizBtn" style="margin-right: 10px;">
                  <i class="fas fa-save"></i> Save & Publish Quiz
                </button>
                <button type="button" class="btn-outline-primary" style="color: #666; border-color: #666;" id="cancelQuizBtn">
                  Cancel
                </button>
                <div style="margin-top:10px;">
                  <small id="form_message" class="form-text"></small>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- TAB 3: MY QUIZZES -->
      <div id="my-quizzes" class="tab-pane teacher-only">
        <div class="card">
          <div class="card-header">
            <h3 style="margin: 0;">My Created Quizzes</h3>
          </div>
          <div class="card-body">
            <div id="myQuizzesContainer">
              <!-- Quizzes will be dynamically added here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PREVIEW MODAL -->
  <div class="preview-modal" id="previewModal">
    <div class="preview-content">
      <div class="preview-header">
        <h3 id="previewQuizTitle">Quiz Preview</h3>
        <button class="close-btn" id="closePreview">&times;</button>
      </div>
      <div class="preview-body" id="previewQuizBody">
        <!-- Preview content will be added here -->
      </div>
    </div>
  </div>

  <script>
    // Basic data storage for quizzes
    var myQuizzes = [];
    var allQuizzes = [
      {
        id: 'math-basics',
        title: 'Math Basics',
        category: 'math',
        grade: '5',
        description: 'Numbers, operations, and simple algebra.',
        questionCount: 15,
        status: 'active',
        createdBy: 'system'
      }
    ];
    
    // Initialize when page loads
    window.onload = function() {
      // Fetch quizzes from server (strict non-HTML5) so created quizzes persist after refresh
      fetchAllQuizzes();
    };
    
    function fetchAllQuizzes() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=getAllQuizzes', true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          try {
            var res = JSON.parse(xhr.responseText);
            if (res.success && res.quizzes) {
              // Normalize and set allQuizzes
              allQuizzes = res.quizzes.map(function(q) {
                return {
                  id: q.id || q.quiz_id || q.quizId,
                  title: q.title || '',
                  category: q.category || '',
                  gradeLevel: q.grade || q.gradeLevel || '',
                  description: q.description || '',
                  questionCount: q.question_count || q.questionCount || 0,
                  status: q.status || 'active',
                  createdBy: q.created_by || q.createdBy || 'system',
                  createdDate: q.created_at || q.createdDate || '' ,
                  questions: q.questions || [] ,
                  passingGrade: q.passing_grade || q.passingGrade || null,
                  timeLimit: q.time_limit || q.timeLimit || null
                };
              });
              // Mark quizzes created by this client using cookie (non-HTML5 storage)
              try {
                var createdIdsCookie = document.cookie.replace(/(?:(?:^|.*;\s*)myCreatedQuizzes\s*\=\s*([^;]*).*$)|^.*$/, "$1");
                var createdArr = createdIdsCookie ? createdIdsCookie.split(',') : [];
                for (var ci = 0; ci < allQuizzes.length; ci++) {
                  if (createdArr.indexOf(String(allQuizzes[ci].id)) !== -1) {
                    allQuizzes[ci].createdBy = 'you';
                  }
                }
              } catch (e) {}

              // myQuizzes are those marked as createdBy === 'you'
              myQuizzes = allQuizzes.filter(function(q) { return q.createdBy === 'you'; });
            }
          } catch (e) {
            // ignore parse errors
          }

          updateStats();
          displayBrowseQuizzes();
          displayMyQuizzes();
          setupTabSwitching();
          setupRoleSwitching();
        }
      };
      xhr.send();
    }

    function setupTabSwitching() {
      // Tab switching
      var tabs = document.getElementById('mainTabs').getElementsByTagName('a');
      for (var i = 0; i < tabs.length; i++) {
        tabs[i].onclick = function(e) {
          e = e || window.event;
          if (e.preventDefault) {
            e.preventDefault();
          } else {
            e.returnValue = false;
          }
          
          // Remove active class from all tabs
          for (var j = 0; j < tabs.length; j++) {
            tabs[j].className = tabs[j].className.replace(' active', '');
          }
          
          // Hide all tab panes
          var panes = document.getElementsByClassName('tab-pane');
          for (var k = 0; k < panes.length; k++) {
            panes[k].className = panes[k].className.replace(' active', '');
          }
          
          // Add active class to clicked tab
          this.className += ' active';
          
          // Show corresponding tab pane
          var targetId = this.getAttribute('href').substring(1);
          document.getElementById(targetId).className += ' active';
          
          // Refresh quiz lists when switching to those tabs
          if (targetId === 'my-quizzes') {
            displayMyQuizzes();
          } else if (targetId === 'browse-quizzes') {
            displayBrowseQuizzes();
          }
        };
      }
    }
    
    function setupRoleSwitching() {
      // Role switching
      document.getElementById('userRole').onclick = function() {
        var currentRole = this.innerHTML;
        if (currentRole === 'Teacher') {
          this.innerHTML = 'Student';
          var teacherElements = document.getElementsByClassName('teacher-only');
          for (var i = 0; i < teacherElements.length; i++) {
            teacherElements[i].className += ' hidden';
          }
        } else {
          this.innerHTML = 'Teacher';
          var teacherElements = document.getElementsByClassName('teacher-only');
          for (var i = 0; i < teacherElements.length; i++) {
            teacherElements[i].className = teacherElements[i].className.replace(' hidden', '');
          }
        }
      };
    }
    
    function displayMyQuizzes() {
      var container = document.getElementById('myQuizzesContainer');
      
      if (myQuizzes.length === 0) {
        container.innerHTML = '<div class="empty-state" id="emptyMyQuizzes">' +
            '<i class="fas fa-file-alt"></i>' +
            '<h4>No quizzes created yet</h4>' +
            '<p>Create your first quiz to see it listed here</p>' +
            '<button class="btn-primary" onclick="switchToCreateTab()">Create Quiz</button>' +
          '</div>';
        return;
      }
      
      var html = '<div style="overflow-x: auto;">' +
          '<table class="table">' +
            '<thead>' +
              '<tr>' +
                '<th>Quiz Name</th>' +
                '<th>Category</th>' +
                '<th>Questions</th>' +
                '<th>Status</th>' +
                '<th>Created</th>' +
                '<th>Actions</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody>';
      
      for (var i = 0; i < myQuizzes.length; i++) {
        var quiz = myQuizzes[i];
        var statusBadge = quiz.quizStatus === 'active' ? 
          '<span class="badge bg-success">Active</span>' : 
          '<span class="badge bg-secondary">Draft</span>';
        
        html += '<tr>' +
            '<td>' + quiz.title + ' <span class="teacher-badge">You</span></td>' +
            '<td><span class="badge bg-primary">' + getCategoryName(quiz.category) + '</span></td>' +
            '<td>' + quiz.questionCount + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '<td>' + quiz.createdDate + '</td>' +
            '<td>' +
              '<button class="btn-outline-primary btn-sm" onclick="previewQuiz(\'' + quiz.id + '\', true)">Preview</button>' +
              '<button class="btn-outline-primary btn-sm" style="color: #e63946; border-color: #e63946; margin-left: 5px;" onclick="deleteMyQuiz(\'' + quiz.id + '\')">Delete</button>' +
            '</td>' +
          '</tr>';
      }
      
      html += '</tbody></table></div>';
      
      container.innerHTML = html;
    }
    
    function displayBrowseQuizzes() {
      var container = document.getElementById('browseQuizzesContainer');
      
      if (allQuizzes.length === 0) {
        container.innerHTML = '<div class="empty-state">' +
            '<i class="fas fa-search"></i>' +
            '<h4>No quizzes available</h4>' +
            '<p>Create a quiz to see it listed here</p>' +
          '</div>';
        return;
      }
      
      var html = '';
      
      for (var i = 0; i < allQuizzes.length; i++) {
        var quiz = allQuizzes[i];
        var isMyQuiz = false;
        for (var j = 0; j < myQuizzes.length; j++) {
          if (myQuizzes[j].id === quiz.id) {
            isMyQuiz = true;
            break;
          }
        }
        var createdBy = isMyQuiz ? '<span class="teacher-badge">You</span>' : '';
        
        var buttons = isMyQuiz ? 
          '<div style="margin-top: 15px; overflow: hidden;">' +
             '<button class="btn-outline-primary" style="float: left;" onclick="previewQuiz(\'' + quiz.id + '\')">Preview</button>' +
             '<button class="btn-danger btn-sm" style="float: right;" onclick="deleteQuizFromBrowse(\'' + quiz.id + '\')">' +
               '<i class="fas fa-trash"></i> Delete' +
             '</button>' +
           '</div>' :
          '<div style="margin-top: 15px; overflow: hidden;">' +
             '<button class="btn-outline-primary" style="float: left;" onclick="previewQuiz(\'' + quiz.id + '\')">Preview</button>' +
                '<button class="btn-primary" style="float: right;" id="take-quiz-' + quiz.id + '">Take Quiz</button>' +
           '</div>';
        
        html += '<div class="card quiz-card">' +
            '<span class="quiz-badge">' + getCategoryName(quiz.category) + '</span>' +
            '<h3 style="margin: 0 0 10px 0;">' + quiz.title + ' ' + createdBy + '</h3>' +
            '<p style="margin: 0 0 15px 0; color: #666;">' + quiz.description + '</p>' +
            '<div style="margin-bottom: 15px; overflow: hidden;">' +
              '<span class="text-muted small" style="float: left;">' + quiz.questionCount + ' Questions</span>' +
              '<span class="text-muted small" style="float: right;">Grade ' + quiz.gradeLevel + '</span>' +
            '</div>' +
            buttons +
          '</div>';
      }
      
      container.innerHTML = html;
    }
    
    function getCategoryName(category) {
      var categories = {
        'math': 'Mathematics',
        'science': 'Science',
        'english': 'English',
        'social-studies': 'Social Studies',
        'history': 'History',
        'geography': 'Geography',
        'biology': 'Biology',
        'chemistry': 'Chemistry',
        'physics': 'Physics',
        'earth-science': 'Earth Science',
        'environmental-science': 'Environmental Science',
        'astronomy': 'Astronomy',
        'art': 'Art',
        'music': 'Music',
        'other': 'Other'
      };
      
      return categories[category] || category;
    }
    
    function updateStats() {
      // Update my quizzes count
      document.getElementById('myQuizzesCount').innerHTML = myQuizzes.length;
      
      // Update available quizzes count
      document.getElementById('availableQuizzes').innerHTML = allQuizzes.length;
    }
    
    function switchToCreateTab() {
      document.querySelector('a[href="#create-quiz"]').click();
    }
    
    function previewQuiz(quizId, fromMyQuizzes) {
      var quiz;
      var quizArray = fromMyQuizzes ? myQuizzes : allQuizzes;
      
      for (var i = 0; i < quizArray.length; i++) {
        if (quizArray[i].id === quizId) {
          quiz = quizArray[i];
          break;
        }
      }
      if (!quiz) return;
      
      // Set preview title
      document.getElementById('previewQuizTitle').innerHTML = quiz.title + ' - Preview';
      
      // Build preview content
      var previewHTML = '<div style="margin-bottom: 20px;">' +
          '<p><strong>Description:</strong> ' + quiz.description + '</p>' +
          '<p><strong>Grade Level:</strong> ' + quiz.gradeLevel + '</p>' +
          '<p><strong>Questions:</strong> ' + quiz.questionCount + '</p>' +
          '<p><strong>Passing Grade:</strong> ' + quiz.passingGrade + '%</p>' +
          (quiz.timeLimit ? '<p><strong>Time Limit:</strong> ' + quiz.timeLimit + ' minutes</p>' : '') +
        '</div>' +
        '<hr>';
      
      // Add questions to preview if available
      if (quiz.questions && quiz.questions.length > 0) {
        for (var i = 0; i < quiz.questions.length; i++) {
          var question = quiz.questions[i];
          previewHTML += '<div class="preview-question">' +
              '<h5>Question ' + (i + 1) + '</h5>' +
              '<p>' + question.text + '</p>' +
              '<div class="preview-options">';
          
          // Support multiple saved option formats:
          // 1) Array of option objects from DB: { option_label, option_text, is_correct }
          // 2) Array of option objects from client: { value, text, is_correct }
          // 3) Object mapping letters to { text, is_correct }
          var opts = question.options;
          if (Array.isArray(opts)) {
            for (var j = 0; j < opts.length; j++) {
              var option = opts[j] || {};
              var label = '';
              var text = '';
              var isCorrect = false;

              if (option.option_label !== undefined) {
                label = option.option_label + ':';
              } else if (option.value !== undefined) {
                label = option.value.toUpperCase() + ':';
              } else {
                // fallback to letter by index
                label = String.fromCharCode(65 + j) + ':';
              }

              text = option.option_text || option.text || '';
              if (option.is_correct === 1 || option.is_correct === true || option.is_correct === '1') {
                isCorrect = true;
              }

              var optionClass = isCorrect ? 'preview-option correct' : 'preview-option';
              previewHTML += '<div class="' + optionClass + '">' +
                  '<strong>' + label + '</strong> ' + text +
                  (isCorrect ? ' <i class="fas fa-check" style="color: #2ecc71;"></i>' : '') +
                '</div>';
            }
          } else if (opts && typeof opts === 'object') {
            // object mapping like { A: { text:'', is_correct:true }, B: {...} }
            var letters = Object.keys(opts).sort();
            for (var li = 0; li < letters.length; li++) {
              var letter = letters[li];
              var option = opts[letter] || {};
              var text = option.text || '';
              var isCorrect = option.is_correct === true || option.is_correct === '1' || option.is_correct === 1;
              var optionClass = isCorrect ? 'preview-option correct' : 'preview-option';
              previewHTML += '<div class="' + optionClass + '">' +
                  '<strong>' + letter.toUpperCase() + ':</strong> ' + text +
                  (isCorrect ? ' <i class="fas fa-check" style="color: #2ecc71;"></i>' : '') +
                '</div>';
            }
          }
          
          previewHTML += '</div></div>';
        }
      } else {
        previewHTML += '<p>No questions available for preview.</p>';
      }
      
      // Set preview content and show modal
      document.getElementById('previewQuizBody').innerHTML = previewHTML;
      document.getElementById('previewModal').style.display = 'block';
    }
    
    function deleteMyQuiz(quizId) {
      if (confirm('Are you sure you want to delete this quiz?')) {
        requestDeleteQuiz(quizId);
      }
    }
    
    function deleteQuizFromBrowse(quizId) {
      if (confirm('Are you sure you want to delete this quiz?')) {
        requestDeleteQuiz(quizId);
      }
    }
    
    function deleteQuizFromStorage(quizId) {
      // Remove from my quizzes
      var newMyQuizzes = [];
      for (var i = 0; i < myQuizzes.length; i++) {
        if (myQuizzes[i].id !== quizId) {
          newMyQuizzes.push(myQuizzes[i]);
        }
      }
      myQuizzes = newMyQuizzes;
      // (No localStorage usage - strict non-HTML5)
      
      // Remove from all quizzes
      var newAllQuizzes = [];
      for (var j = 0; j < allQuizzes.length; j++) {
        if (allQuizzes[j].id !== quizId) {
          newAllQuizzes.push(allQuizzes[j]);
        }
      }
      allQuizzes = newAllQuizzes;
      
      // Update displays
      displayMyQuizzes();
      displayBrowseQuizzes();
      updateStats();
    }

    // Send delete request to server, then remove locally on success
    function requestDeleteQuiz(quizId) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '../controller/quizcontroller.php?action=deleteQuiz&id=' + encodeURIComponent(quizId), true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          var msgEl = document.getElementById('form_message');
          try {
            var res = JSON.parse(xhr.responseText);
            if (res.success) {
              // Remove id from created cookie so it doesn't reappear as "You" after refresh
              removeIdFromCreatedCookie(quizId);
              // Remove from client-side arrays and UI
              deleteQuizFromStorage(quizId);
              if (msgEl) {
                msgEl.innerText = res.message || 'Quiz deleted successfully.';
                msgEl.className = 'form-text success-message';
                setTimeout(function() { if (msgEl) msgEl.innerText = ''; }, 3000);
              }
            } else {
              if (msgEl) msgEl.innerText = 'Delete failed: ' + (res.message || xhr.statusText);
            }
          } catch (e) {
            if (msgEl) msgEl.innerText = 'Server error while deleting quiz.';
          }
        }
      };
      xhr.send();
    }

    function removeIdFromCreatedCookie(id) {
      try {
        var cookieVal = document.cookie.replace(/(?:(?:^|.*;\s*)myCreatedQuizzes\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        if (!cookieVal) return;
        var arr = cookieVal.split(',').filter(function(x){ return x && x.length; });
        var idx = arr.indexOf(String(id));
        if (idx !== -1) {
          arr.splice(idx, 1);
          document.cookie = 'myCreatedQuizzes=' + arr.join(',') + '; path=/';
        }
      } catch (e) {}
    }
    
    // Preview modal functionality
    document.getElementById('closePreview').onclick = function() {
      document.getElementById('previewModal').style.display = 'none';
    };
    
    window.onclick = function(e) {
      if (e.target == document.getElementById('previewModal')) {
        document.getElementById('previewModal').style.display = 'none';
      }
    };
  </script>
  <script src="quiz-form.js"></script>
</body>
</html>