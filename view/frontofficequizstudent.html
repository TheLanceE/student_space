<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>EduMind+ | Student Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Keep all the CSS styles from the original file */
    body { font-family: Arial, sans-serif; background-color: #f5f7fb; margin: 0; padding: 0; }
    .navbar { background-color: #4361ee; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar-brand { color: white; font-weight: bold; font-size: 24px; text-decoration: none; margin-left: 20px; }
    .nav-links { display: flex; list-style: none; margin: 0; padding: 0; margin-left: 30px; }
    .nav-links li { margin-right: 20px; }
    .nav-links a { color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; }
    .nav-links a.active { background-color: rgba(255,255,255,0.2); }
    .user-role { background: rgba(255,255,255,0.2); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-left: 10px; cursor: pointer; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .welcome-section { background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%); color: white; border-radius: 10px; padding: 30px; margin-bottom: 30px; }
    .card { background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; padding: 20px; border: 1px solid #e0e0e0; }
    .stats-card { text-align: center; padding: 20px 15px; }
    .stats-card i { font-size: 32px; margin-bottom: 15px; color: #4361ee; }
    .stats-card .number { font-size: 32px; font-weight: bold; margin: 10px 0; }
    .quiz-card { position: relative; height: 100%; transition: transform 0.3s; }
    .quiz-card:hover { transform: translateY(-5px); }
    .quiz-badge { position: absolute; top: 15px; right: 15px; background: #4361ee; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 12px; }
    .teacher-badge { background: #4cc9f0; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px; }
    .btn-primary { background: #4361ee; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-success { background: #4cc9f0; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    .btn-outline-primary { background: transparent; color: #4361ee; border: 1px solid #4361ee; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
    .quiz-container { max-width: 800px; margin: 0 auto; }
    .question-card { margin-bottom: 20px; border-left: 4px solid #4361ee; }
    .question-number { font-weight: bold; color: #4361ee; margin-bottom: 10px; }
    .question-text { font-size: 18px; margin-bottom: 15px; }
    .option-label { display: block; padding: 12px 15px; margin-bottom: 8px; border: 1px solid #e0e0e0; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
    .option-label:hover { background: #f8f9fa; }
    .option-label.selected { background: #e8f4ff; border-color: #4361ee; }
    .option-input { margin-right: 10px; }
    .quiz-progress { margin-bottom: 20px; }
    .progress-bar { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: #4361ee; transition: width 0.3s; }
    .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .quiz-timer { background: #f8f9fa; padding: 8px 15px; border-radius: 5px; font-weight: bold; color: #4361ee; }
    .results-container { text-align: center; padding: 30px; }
    .score-circle { width: 150px; height: 150px; border-radius: 50%; background: #4361ee; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto 20px; }
    .score-percentage { font-size: 32px; font-weight: bold; }
    .score-text { font-size: 14px; }
    .pass-message { color: #2ecc71; font-weight: bold; margin-top: 10px; }
    .fail-message { color: #e63946; font-weight: bold; margin-top: 10px; }
    .question-review { text-align: left; margin-top: 30px; }
    .correct-answer { color: #2ecc71; font-weight: bold; }
    .incorrect-answer { color: #e63946; font-weight: bold; }
    .row { display: flex; flex-wrap: wrap; margin: 0 -15px; }
    .col-md-3 { width: 25%; padding: 0 15px; box-sizing: border-box; }
    .col-md-4 { width: 33.333%; padding: 0 15px; box-sizing: border-box; }
    .col-md-6 { width: 50%; padding: 0 15px; box-sizing: border-box; }
    .col-md-8 { width: 66.666%; padding: 0 15px; box-sizing: border-box; }
    .d-flex { display: flex; }
    .justify-content-between { justify-content: space-between; }
    .align-items-center { align-items: center; }
    .mb-4 { margin-bottom: 30px; }
    .mt-4 { margin-top: 30px; }
    .text-muted { color: #666; }
    .hidden { display: none; }
    .quiz-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .empty-state { text-align: center; padding: 40px; color: #666; }
    .empty-state i { font-size: 48px; margin-bottom: 15px; color: #ddd; }
    @media (max-width: 768px) {
      .col-md-3, .col-md-4, .col-md-6, .col-md-8 { width: 100%; }
      .quiz-list { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- NAVIGATION BAR -->
  <div class="navbar">
    <div class="container">
      <div class="d-flex align-items-center">
        <a href="#" class="navbar-brand">
          <i class="fas fa-graduation-cap"></i> EduMind
        </a>
        <ul class="nav-links">
          <li><a href="#" class="active">Dashboard</a></li>
          <li><a href="#">My Quizzes</a></li>
          <li><a href="#">Progress</a></li>
        </ul>
        <div style="margin-left: auto;" class="d-flex align-items-center">
          <span class="user-role">Student</span>
          <button class="btn-outline-primary" style="color: white; border-color: white; margin-left: 10px;">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="container">
    <!-- WELCOME SECTION -->
    <div class="welcome-section">
      <div class="row">
        <div class="col-md-8">
          <h1 style="margin: 0 0 10px 0;">Welcome to EduMind Student Portal</h1>
          <p style="margin: 0; font-size: 16px;">Take quizzes created by your teachers and track your progress.</p>
        </div>
        <div class="col-md-4 text-end">
          <div style="background: white; color: #4361ee; border-radius: 50%; width: 80px; height: 80px; display: inline-flex; align-items: center; justify-content: center;">
            <i class="fas fa-user-graduate" style="font-size: 32px;"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- STATS CARDS -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-list-alt"></i>
          <div class="number" id="availableQuizzes">0</div>
          <div class="text-muted">Available Quizzes</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-check-circle"></i>
          <div class="number" id="completedQuizzes">0</div>
          <div class="text-muted">Quizzes Completed</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-trophy"></i>
          <div class="number" id="averageScore">0%</div>
          <div class="text-muted">Average Score</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card">
          <i class="fas fa-star"></i>
          <div class="number" id="totalPoints">0</div>
          <div class="text-muted">Total Points</div>
        </div>
      </div>
    </div>

    <!-- AVAILABLE QUIZZES -->
    <div class="card" id="availableQuizzesCard">
      <div class="card-header">
        <h3 style="margin: 0;">Available Quizzes</h3>
      </div>
      <div class="card-body">
        <div class="quiz-list" id="availableQuizzesContainer">
          <!-- Quizzes will be dynamically added here -->
        </div>
      </div>
    </div>

    <!-- QUIZ TAKING INTERFACE (HIDDEN BY DEFAULT) -->
    <div id="quizTakingInterface" class="hidden">
      <div class="quiz-container">
        <div class="card">
          <div class="card-header">
            <div class="quiz-header">
              <h3 id="quizTitle">Quiz Title</h3>
              <div style="display:flex; align-items:center; gap:15px;">
                <div id="currentScoreDisplay" style="background:#f8f9fa; padding:6px 12px; border-radius:6px; font-weight:bold; color:#4361ee;">Score: 0</div>
                <div class="quiz-timer">
                <i class="fas fa-clock"></i> Time: <span id="quizTimer">00:00</span>
                </div>
              </div>
            </div>
            <div class="quiz-progress">
              <div>Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span></div>
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 10%"></div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div id="questionContainer">
              <!-- Questions will be dynamically added here -->
            </div>
            <div class="d-flex justify-content-between mt-4">
              <button class="btn-outline-primary" id="prevQuestionBtn" disabled>
                <i class="fas fa-arrow-left"></i> Previous
              </button>
              <button class="btn-primary" id="nextQuestionBtn">
                Next <i class="fas fa-arrow-right"></i>
              </button>
              <button class="btn-success hidden" id="submitQuizBtn">
                <i class="fas fa-paper-plane"></i> Submit Quiz
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- QUIZ RESULTS (HIDDEN BY DEFAULT) -->
    <div id="quizResults" class="hidden">
      <div class="card">
        <div class="card-body results-container">
          <div class="score-circle">
            <div class="score-percentage" id="scorePercentage">0%</div>
            <div class="score-text">Your Score</div>
          </div>
          <h3>Quiz Completed!</h3>
          <div id="passMessage"></div>
          <p>You scored <span id="finalScore">0</span> out of <span id="totalScore">0</span> points</p>
          <div class="d-flex justify-content-center mt-4">
            <button class="btn-outline-primary me-2" id="reviewQuizBtn">
              <i class="fas fa-search"></i> Review Answers
            </button>
            <button class="btn-primary" id="backToQuizzesBtn">
              <i class="fas fa-list"></i> Back to Quizzes
            </button>
          </div>
          
          <div id="questionReview" class="question-review hidden">
            <h4 class="mt-4">Question Review</h4>
            <div id="reviewContainer">
              <!-- Review content will be added here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Student Front Office JavaScript - Pure PHP/MySQL version
    document.addEventListener('DOMContentLoaded', function() {
      // Quiz data will be loaded from the server
      var availableQuizzes = [];

      // DOM Elements
      var availableQuizzesContainer = document.getElementById('availableQuizzesContainer');
      var quizTakingInterface = document.getElementById('quizTakingInterface');
      var quizResults = document.getElementById('quizResults');
      var quizTitle = document.getElementById('quizTitle');
      var questionContainer = document.getElementById('questionContainer');
      var currentQuestionEl = document.getElementById('currentQuestion');
      var totalQuestionsEl = document.getElementById('totalQuestions');
      var progressFill = document.getElementById('progressFill');
      var prevQuestionBtn = document.getElementById('prevQuestionBtn');
      var nextQuestionBtn = document.getElementById('nextQuestionBtn');
      var submitQuizBtn = document.getElementById('submitQuizBtn');
      var quizTimer = document.getElementById('quizTimer');
      var scorePercentage = document.getElementById('scorePercentage');
      var finalScore = document.getElementById('finalScore');
      var totalScore = document.getElementById('totalScore');
      var reviewQuizBtn = document.getElementById('reviewQuizBtn');
      var backToQuizzesBtn = document.getElementById('backToQuizzesBtn');
      var questionReview = document.getElementById('questionReview');
      var reviewContainer = document.getElementById('reviewContainer');

      // Current quiz state
      var currentQuiz = null;
      var currentQuestionIndex = 0;
      var userAnswers = {};
      var timerInterval = null;
      var timeRemaining = 0;

      // Initialize the app: fetch teacher-created quizzes from server
      fetchAvailableQuizzes();

      function fetchAvailableQuizzes() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '../controller/quizcontroller.php?action=getAllQuizzes', true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            try {
              // Parse HTML response from PHP - it returns table rows
              var tempDiv = document.createElement('div');
              tempDiv.innerHTML = '<table>' + xhr.responseText + '</table>';
              var rows = tempDiv.querySelectorAll('tr');
              
              availableQuizzes = [];
              for (var i = 0; i < rows.length; i++) {
                var row = rows[i];
                var cells = row.querySelectorAll('td');
                
                if (cells.length >= 6) {
                  // Extract data from table cells
                  var title = cells[0].textContent.trim();
                  var teacher = cells[1].textContent.trim();
                  var category = cells[2].querySelector('.badge') ? cells[2].querySelector('.badge').textContent.trim() : '';
                  var grade = cells[3].textContent.trim();
                  var status = cells[4].querySelector('.badge') ? cells[4].querySelector('.badge').textContent.trim() : '';
                  
                  // Only show active quizzes
                  if (status.toLowerCase() === 'active') {
                    // Extract quiz ID from the button onclick attribute
                    var previewBtn = cells[6].querySelector('button[onclick*="previewQuiz"]');
                    var quizId = null;
                    if (previewBtn) {
                      var onclickAttr = previewBtn.getAttribute('onclick');
                      var match = onclickAttr.match(/previewQuiz\((\d+)\)/);
                      if (match) {
                        quizId = match[1];
                      }
                    }
                    
                    if (quizId && title) {
                      availableQuizzes.push({
                        id: quizId,
                        title: title,
                        teacher: teacher,
                        category: category,
                        grade: grade
                      });
                    }
                  }
                }
              }
              
              // After loading available quizzes, fetch which ones were attempted
              fetchAttemptedQuizIds(function(attemptedMap) {
                for (var k = 0; k < availableQuizzes.length; k++) {
                  var q = availableQuizzes[k];
                  q.attempted = !!attemptedMap[q.id];
                }
                displayAvailableQuizzes();
                updateStats();
              });
            } catch (e) {
              console.error('Error loading quizzes:', e);
              availableQuizzesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h4>Error loading quizzes</h4><p>Please try again later</p></div>';
            }
          }
        };
        xhr.send();
      }

      // Fetch attempted quiz IDs for current student (HTML-only API)
      function fetchAttemptedQuizIds(callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '../controller/quizcontroller.php?action=getAttemptedQuizIds', true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            var map = {};
            if (xhr.status === 200) {
              try {
                var temp = document.createElement('div');
                temp.innerHTML = xhr.responseText;
                var lis = temp.querySelectorAll('.attempted-quiz-ids li[data-quiz-id]');
                for (var i = 0; i < lis.length; i++) {
                  var id = lis[i].getAttribute('data-quiz-id');
                  if (id) { map[id] = true; }
                }
              } catch (e) { /* ignore parse errors */ }
            }
            try { callback(map); } catch (e) { /* ignore callback errors */ }
          }
        };
        xhr.send();
      }

      // Display available quizzes
      function displayAvailableQuizzes() {
        if (availableQuizzes.length === 0) {
          availableQuizzesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><h4>No quizzes available</h4><p>Check back later for new quizzes from your teachers</p></div>';
          return;
        }

        var html = '';
        for (var i = 0; i < availableQuizzes.length; i++) {
          var quiz = availableQuizzes[i];
          html += '<div class="card quiz-card">';
          html += '<span class="quiz-badge">' + quiz.category + '</span>';
          html += '<h3 style="margin: 0 0 10px 0;">' + quiz.title + '</h3>';
          html += '<p style="margin: 0 0 10px 0; color: #666;">Grade ' + quiz.grade + '</p>';
          html += '<div class="d-flex justify-content-between align-items-center mb-3">';
          html += '<span class="text-muted small"><i class="fas fa-user"></i> ' + quiz.teacher + '</span>';
          html += '</div>';
          html += '<div class="d-flex justify-content-between align-items-center">';
          html += '<span class="teacher-badge"><i class="fas fa-chalkboard-teacher"></i> ' + quiz.teacher + '</span>';
          html += '<button class="btn-primary start-quiz" data-quiz-id="' + quiz.id + '">';
          html += '<i class="fas fa-play"></i> ' + (quiz.attempted ? 'Retake Quiz' : 'Start Quiz');
          html += '</button>';
          html += '</div>';
          html += '</div>';
        }

        availableQuizzesContainer.innerHTML = html;

        // Add event listeners to start quiz buttons
        var startButtons = document.querySelectorAll('.start-quiz');
        for (var i = 0; i < startButtons.length; i++) {
          (function(button) {
            button.addEventListener('click', function() {
              var quizId = this.getAttribute('data-quiz-id');
              startQuiz(quizId);
            });
          })(startButtons[i]);
        }
      }

      // Start a quiz - load quiz data (with IDs) and show quiz interface
      function startQuiz(quizId) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '../controller/quizcontroller.php?action=getQuizForTaking&id=' + quizId, true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(xhr.responseText, 'text/html');

            var root = doc.querySelector('.quiz-take');
            if (!root) { alert('Unable to load quiz.'); return; }

            var title = root.querySelector('h3') ? root.querySelector('h3').textContent : 'Quiz';
            var qDivs = root.querySelectorAll('.quiz-q');

            currentQuiz = { id: quizId, title: title, questions: [] };

            for (var i = 0; i < qDivs.length; i++) {
              var qDiv = qDivs[i];
              var qId = parseInt(qDiv.getAttribute('data-question-id'));
              var qTextEl = qDiv.querySelector('.q-text');
              var qText = qTextEl ? qTextEl.textContent : '';
              var inputs = qDiv.querySelectorAll('input[type="radio"]');
              var options = [];
              for (var j = 0; j < inputs.length; j++) {
                var input = inputs[j];
                var labelText = input.parentElement.textContent.trim();
                var parts = labelText.split('.');
                var label = parts[0] ? parts[0].trim() : '';
                var text = parts.length > 1 ? parts.slice(1).join('.').trim() : '';
                options.push({ id: parseInt(input.value), label: label, text: text });
              }
              currentQuiz.questions.push({ id: qId, text: qText, options: options });
            }

            if (currentQuiz.questions.length > 0) {
              userAnswers = {};
              currentQuestionIndex = 0;
              startQuizInterface();
            } else {
              alert('This quiz has no questions yet.');
            }
          }
        };
        xhr.send();
      }

      // Update statistics
      function updateStats() {
        document.getElementById('availableQuizzes').textContent = availableQuizzes.length;
        fetchStudentStats();
      }

      // Fetch student stats (completed quizzes, averages) from server
      function fetchStudentStats() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '../controller/quizcontroller.php?action=getStats', true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              try {
                var temp = document.createElement('div');
                temp.innerHTML = xhr.responseText;
                // Find all stat blocks and map by label
                var stats = temp.querySelectorAll('.stat');
                for (var i = 0; i < stats.length; i++) {
                  var labelEl = stats[i].querySelector('.text-muted');
                  var valueEl = stats[i].querySelector('.h4');
                  if (!labelEl || !valueEl) continue;
                  var label = labelEl.textContent || '';
                  var value = (valueEl.textContent || '').trim();
                  if (label.indexOf('Quizzes Completed') !== -1) {
                    var cq = document.getElementById('completedQuizzes');
                    if (cq) cq.textContent = value.replace(/[^0-9]/g, '') || '0';
                  } else if (label.indexOf('Average Score') !== -1) {
                    var as = document.getElementById('averageScore');
                    if (as) as.textContent = value.match(/%$/) ? value : (value + '%');
                  }
                }
              } catch (e) {
                console.warn('Failed to parse student stats:', e);
              }
            } else {
              // Non-blocking: stats are optional for UI
              console.warn('Could not fetch stats. Status:', xhr.status);
            }
          }
        };
        xhr.send();
      }

      // Start quiz interface
      function startQuizInterface() {
        document.getElementById('availableQuizzesCard').style.display = 'none';
        document.getElementById('quizTakingInterface').classList.remove('hidden');
        
        quizTitle.textContent = currentQuiz.title;
        totalQuestionsEl.textContent = currentQuiz.questions.length;
        
        // Start timer if quiz has time limit
        timeRemaining = 1800; // 30 minutes default
        startTimer();
        
        // Display first question
        displayQuestion();
      }

      // Display current question
      function displayQuestion() {
        var question = currentQuiz.questions[currentQuestionIndex];
        currentQuestionEl.textContent = currentQuestionIndex + 1;
        
        // Update progress bar
        var progress = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
        progressFill.style.width = progress + '%';
        
        // Update answered count display (no client scoring)
        var answeredCount = 0;
        for (var k in userAnswers) { if (userAnswers.hasOwnProperty(k)) { answeredCount++; } }
        document.getElementById('currentScoreDisplay').textContent = 'Answered: ' + answeredCount + '/' + currentQuiz.questions.length;
        
        // Build question HTML
        var html = '<div class="card question-card">';
        html += '<div class="card-body">';
        html += '<div class="question-number">Question ' + (currentQuestionIndex + 1) + ' of ' + currentQuiz.questions.length + ' (10 points)</div>';
        html += '<div class="question-text">' + question.text + '</div>';
        html += '<div class="options-container">';
        
        for (var i = 0; i < question.options.length; i++) {
          var opt = question.options[i];
          var selectedId = userAnswers[currentQuestionIndex];
          var checked = selectedId === opt.id ? 'checked' : '';
          html += '<label class="option-label ' + (checked ? 'selected' : '') + '">';
          html += '<input type="radio" name="question_' + currentQuestionIndex + '" value="' + opt.id + '" class="option-input" ' + checked + '>';
          html += '<strong>' + opt.label + '.</strong> ' + opt.text;
          html += '</label>';
        }
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        questionContainer.innerHTML = html;
        
        // Add event listeners to options
        var optionInputs = questionContainer.querySelectorAll('.option-input');
        for (var i = 0; i < optionInputs.length; i++) {
          optionInputs[i].addEventListener('change', function() {
            userAnswers[currentQuestionIndex] = parseInt(this.value);
            
            // Update selected styling
            var labels = questionContainer.querySelectorAll('.option-label');
            for (var j = 0; j < labels.length; j++) {
              labels[j].classList.remove('selected');
            }
            this.parentElement.classList.add('selected');
          });
        }
        
        // Update navigation buttons
        prevQuestionBtn.disabled = currentQuestionIndex === 0;
        
        if (currentQuestionIndex === currentQuiz.questions.length - 1) {
          nextQuestionBtn.classList.add('hidden');
          submitQuizBtn.classList.remove('hidden');
        } else {
          nextQuestionBtn.classList.remove('hidden');
          submitQuizBtn.classList.add('hidden');
        }
      }

      // Navigation
      prevQuestionBtn.addEventListener('click', function() {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          displayQuestion();
        }
      });

      nextQuestionBtn.addEventListener('click', function() {
        if (currentQuestionIndex < currentQuiz.questions.length - 1) {
          currentQuestionIndex++;
          displayQuestion();
        }
      });

      // Submit quiz (server-side scoring and persistence)
      submitQuizBtn.addEventListener('click', function() {
        if (!currentQuiz || !currentQuiz.questions || currentQuiz.questions.length === 0) return;
        if (!confirm('Are you sure you want to submit your quiz? You cannot change your answers after submission.')) return;

        clearInterval(timerInterval);

        var params = new URLSearchParams();
        params.set('quiz_id', currentQuiz.id);
        // Post each selected answer as question_<id>=<optionId>
        for (var i = 0; i < currentQuiz.questions.length; i++) {
          var q = currentQuiz.questions[i];
          var sel = userAnswers[i];
          if (sel) { params.set('question_' + q.id, sel); }
        }

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '../controller/quizcontroller.php?action=submitAttempt', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              // Hide quiz interface and render server results (already saved in DB)
              quizTakingInterface.classList.add('hidden');
              quizResults.classList.remove('hidden');
              // Replace results container content with server-rendered HTML
              document.getElementById('quizResults').innerHTML = xhr.responseText;
              // Hook Back to Quizzes link to return to main dashboard
              try {
                var links = document.querySelectorAll('#quizResults a');
                for (var i = 0; i < links.length; i++) {
                  var txt = (links[i].textContent || '').toLowerCase();
                  if (txt.indexOf('back to quizzes') !== -1) {
                    links[i].addEventListener('click', function(ev) {
                      ev.preventDefault();
                      window.location.reload();
                    });
                  }
                }
                // Wire up Review Quiz button if present
                var reviewBtn = document.querySelector('#quizResults #reviewAttemptBtn');
                if (reviewBtn) {
                  reviewBtn.addEventListener('click', function(ev) {
                    ev.preventDefault();
                    var attemptId = this.getAttribute('data-attempt');
                    if (!attemptId) return;
                    var rx = new XMLHttpRequest();
                    rx.open('GET', '../controller/quizcontroller.php?action=reviewAttempt&id=' + attemptId, true);
                    rx.onreadystatechange = function() {
                      if (rx.readyState === 4 && rx.status === 200) {
                        document.getElementById('quizResults').innerHTML = rx.responseText;
                        // Re-attach Back to Quizzes hook on review page
                        try {
                          var rlinks = document.querySelectorAll('#quizResults a');
                          for (var j = 0; j < rlinks.length; j++) {
                            var rtxt = (rlinks[j].textContent || '').toLowerCase();
                            if (rtxt.indexOf('back to quizzes') !== -1) {
                              rlinks[j].addEventListener('click', function(e2) {
                                e2.preventDefault();
                                window.location.reload();
                              });
                            }
                          }
                        } catch (e) { /* ignore */ }
                      }
                    };
                    rx.send();
                  });
                }
              } catch (e) { /* no-op */ }
              // Optimistically increment completed count by 1; server fetch will reconcile
              try {
                var cqEl = document.getElementById('completedQuizzes');
                if (cqEl) {
                  var cur = parseInt((cqEl.textContent || '0').replace(/\D/g, ''), 10) || 0;
                  cqEl.textContent = String(cur + 1);
                }
              } catch (e) { /* ignore */ }
              // Refresh student stats (e.g., Quizzes Completed)
              fetchStudentStats();
            } else {
              // Surface errors so the user sees what went wrong
              alert('Error submitting quiz. Status: ' + xhr.status + '\n' + (xhr.responseText || ''));
            }
          }
        };
        xhr.send(params.toString());
      });

      // Timer
      function startTimer() {
        timerInterval = setInterval(function() {
          timeRemaining--;
          
          var minutes = Math.floor(timeRemaining / 60);
          var seconds = timeRemaining % 60;
          
          quizTimer.textContent = 
            (minutes < 10 ? '0' : '') + minutes + ':' + 
            (seconds < 10 ? '0' : '') + seconds;
          
          if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! Your quiz will be submitted automatically.');
            calculateResults();
          }
        }, 1000);
      }

      // Back to quizzes
      backToQuizzesBtn.addEventListener('click', function() {
        window.location.reload();
      });
    });
  </script>
</body>
</html>